<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¤©ä¸‹æ›¸é™¢ï½œå…±è­˜å¤§å¯Œç¿</title>

  <!-- Excel åŒ¯å‡ºï¼ˆxlsxï¼‰ã€‚è‹¥è¼‰ä¸åˆ°æœƒè‡ªå‹• fallback CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(17, 26, 46, .72);
      --text:#eaf1ff;
      --muted:#a9b6d3;
      --line: rgba(255,255,255,.10);
      --shadow: 0 18px 44px rgba(0,0,0,.55);
      --r:20px;

      --pink:#ff6b9b;
      --blue:#60a5fa;
      --green:#22c55e;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --sans: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    *{box-sizing:border-box}
    html, body{
      height:100%;
    }

    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(255,107,155,.16), transparent 60%),
        radial-gradient(900px 700px at 85% 25%, rgba(96,165,250,.14), transparent 60%),
        radial-gradient(1100px 800px at 50% 110%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, #070b14 0%, #050811 100%);
      overflow:hidden;      /* âœ… é—œéµï¼šæ•´é ä¸è¦æ»¾ */
    }
    .app{
      display:grid;
      grid-template-columns: 1.55fr 1fr;
      gap:14px;

      height:100dvh;        /* âœ… æ¯” 100vh æ›´æº–ï¼Œæ©«å‘å¹³æ¿ä¹Ÿç©© */
      min-height:0;         /* âœ… è®“ grid å­é …ç›®å…è¨±è®ŠçŸ®ï¼Œå…§éƒ¨æ‰èƒ½æ»¾ */

      padding:14px;
    }

    /* âœ… Grid å­å…ƒç´ é è¨­ min-height:auto æœƒå®³å…§éƒ¨ overflow å¤±æ•ˆ */
    .app > .panel{
      min-height:0;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;          /* âœ… ä¸è®“å…§å®¹æº¢å‡ºç ´ç‰ˆ */

      display:flex;             /* âœ… é—œéµï¼šè®“ header + content å‚ç›´æ’åˆ— */
      flex-direction:column;
      min-height:0;             /* âœ… é—œéµï¼šå…è¨±å…§å®¹å€ç¸®èµ·ä¾† â†’ æ‰èƒ½æ»¾ */
    }

    header{
      flex:0 0 auto;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    header h1{ margin:0; font-size:15px; letter-spacing:.3px; }
    header .sub{ color:var(--muted); font-size:12px; line-height:1.35; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      transition:.12s transform, .12s background, .12s box-shadow;
      user-select:none;
    }
    .btn:hover{
      background: rgba(255,255,255,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.16); }
    .btn.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.16); }
    .btn.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.16); }
    .btn.pink{ border-color: rgba(255,107,155,.35); background: rgba(255,107,155,.16); }

    .content{
      padding:12px;
      overflow:auto;
      min-height:0;
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background: rgba(15, 24, 45, .68);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
    }
    .card h2{ margin:0 0 8px 0; font-size:14px; letter-spacing:.2px; }
    .divider{ height:1px; background:var(--line); margin:10px 0; }

    /* Map */
    .mapWrap{
      position:relative;
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
    }
    .mapWrap img{
      width:100%;
      height:auto;
      display:block;
      object-fit:contain;
      background: rgba(0,0,0,.20);
    }
    .token{
      position:absolute;
      width: 16px; height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.28);
      box-shadow: 0 10px 22px rgba(0,0,0,.42);
      transform: translate(-50%,-50%);
      pointer-events:none;
      z-index:3;
    }
    .cellDot{
      position:absolute;
      width: 10px; height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      transform: translate(-50%,-50%);
      pointer-events:none;
      z-index:2;
    }

    /* RIGHTï¼ˆåƒå·¦é‚Šä¸€æ¨£ï¼šheader å›ºå®šã€å…§å®¹å€å¯æ»¾å‹•æ‹‰å‹•ï¼‰ */
    .rightContent{
      flex:1 1 auto;            /* âœ… ä½”æ»¿ header ä»¥å¤–çš„é«˜åº¦ */
      min-height:0;             /* âœ… é—œéµï¼šè®“ overflow ç”Ÿæ•ˆ */

      overflow-y:auto;          /* âœ… å³å´å¯ä¸‹æ‹‰ */
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;

      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    details{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      background: rgba(15, 24, 45, .68);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      font-weight:950;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }
    details .inner{
      padding:12px;
      border-top:1px solid var(--line);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    input, textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-family:var(--sans);
      outline:none;
    }
    textarea{ min-height: 92px; resize:vertical; }
    .label{ font-size:12px; color:var(--muted); margin: 8px 0 6px; display:block; }

    .teamItem{
      padding:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.14);
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
    }
    .teamName{ font-weight:950; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .mini{ font-size:12px; color:var(--muted); margin-top:3px; line-height:1.35; }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      white-space:nowrap;
    }

    /* records/cards expandable */
    .recordDetails, .cardDetails{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.16);
      overflow:hidden;
      margin-bottom:8px;
    }
    .recordDetails summary, .cardDetails summary{
      padding:10px 12px;
      font-weight:900;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .recordDetails .body, .cardDetails .body{
      padding:10px 12px;
      border-top:1px solid var(--line);
      font-size:12.8px;
      line-height:1.55;
      color:var(--text);
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* modal (å¼·åˆ¶æ±ºç­–ï¼šä¸èƒ½é»èƒŒæ™¯é—œé–‰) */
    .modalBg{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .modal{
      width:min(980px, 100%);
      max-height: 92dvh;
      overflow:auto;
      background: rgba(15, 24, 45, .96);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.65);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding:6px 6px 10px;
    }
    .modalTop h3{ margin:0; font-size:16px; }
    .modalHero{
      padding:16px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      margin: 10px 0 12px;
      text-align:center;
    }
    .modalHero .d{
      font-size:62px;
      font-weight:990;
      letter-spacing:1px;
      margin:0;
    }
    .modalHero .to{
      font-size:18px;
      margin-top:8px;
      font-weight:950;
    }
    .modalHint{
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
      padding: 0 6px 8px;
    }
    .modalFooter{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      padding:10px 6px 0;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns:1fr; height:auto; overflow:visible; }
      .panel{ min-height: 540px; }
      .rightContent{ max-height:none; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- LEFT -->
    <section class="panel">
      <header>
        <div>
          <h1>å¤©ä¸‹æ›¸é™¢ï½œå…±è­˜å¤§å¯Œç¿</h1>
          <div class="sub" id="statusLine">â€”</div>
        </div>
        <div class="row">
          <button class="btn" id="btnReset">é‡ç½®æœ¬å±€</button>
          <button class="btn" id="btnExportXlsx">åŒ¯å‡º Excel</button>
        </div>
      </header>

      <div class="content">
        <div class="card">
          <h2>å›åˆ</h2>
          <div class="row" style="justify-content:space-between;">
            <div class="row">
              <span class="tag">ç›®å‰éšŠä¼</span>
              <select id="selActiveTeam" style="min-width:260px;"></select>
              <span class="tag" id="turnInfo">â€”</span>
            </div>
            <div class="row">
              <button class="btn ok" id="btnRoll">ğŸ² æ“²éª°å­</button>
              <button class="btn bad" id="btnFinish">ğŸ çµæŸä¸¦çµç®—</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>åœ°åœ–</h2>
          <div class="mapWrap" id="mapWrap">
            <img id="mapImg" src="./map.png" alt="Board Map" />
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel panelRight">
      <header>
        <div>
          <h1>ä¸»æŒé¢æ¿</h1>
          <div class="sub">ï¼ˆè³‡æ–™å„²å­˜åœ¨æ­¤è£ç½®ï¼‰</div>
        </div>
      </header>

      <div class="rightContent">

        <!-- Teams -->
        <details open>
          <summary>
            <span>éšŠä¼åˆ—è¡¨</span>
            <span class="pill" id="teamsCountPill">â€”</span>
          </summary>
          <div class="inner">
            <div class="row" style="justify-content:space-between; margin-bottom:10px;">
              <button class="btn pink" id="btnShuffleTeams">ğŸ”€ æ‰“äº‚é †åº</button>
              <span class="tag">èµ·å§‹é‡‘é è¨­ï¼š$1000</span>
            </div>

            <div class="grid2">
              <div>
                <span class="label">éšŠä¼åç¨±</span>
                <input id="teamName" placeholder="ä¾‹ï¼šç¬¬ 1 çµ„ / A çµ„" />
              </div>
              <div>
                <span class="label">æˆå“¡ï¼ˆå¯ä¸å¡«ï¼‰</span>
                <input id="teamMembers" placeholder="ä¾‹ï¼šå°æ˜ã€å°ç¾" />
              </div>
            </div>

            <div class="grid2" style="margin-top:6px;">
              <div>
                <span class="label">èµ·å§‹ç¾é‡‘</span>
                <input id="teamMoney" type="number" />
              </div>
              <div>
                <span class="label">æ–°å¢</span>
                <button class="btn ok" id="btnAddTeam" style="width:100%;">ï¼‹åŠ å…¥éšŠä¼</button>
              </div>
            </div>

            <div class="divider"></div>
            <div id="teamsList"></div>
          </div>
        </details>

        <!-- Cards -->
        <details open>
          <summary>
            <span>æ©Ÿæœƒ / å‘½é‹å¡ç‰Œåº«</span>
            <span class="pill" id="cardsCountPill">â€”</span>
          </summary>
          <div class="inner">

            <div class="row">
              <button class="btn" id="btnExportCards">åŒ¯å‡ºå¡ç‰Œåº« JSONï¼ˆä¸‹è¼‰ï¼‰</button>
              <button class="btn" id="btnImportCards">åŒ¯å…¥å¡ç‰Œåº« JSONï¼ˆè¦†è“‹ï¼‰</button>
              <button class="btn ok" id="btnMergeCards">åˆä½µåŒ¯å…¥</button>
              <input type="file" id="cardsFile" accept="application/json" style="display:none;">
            </div>

            <span class="label" style="margin-top:10px;">JSON æ–‡å­—æ¡†ï¼ˆå¯ç›´æ¥è²¼ä¸ŠåŒ¯å‡ºçš„å…§å®¹ï¼‰</span>
            <textarea id="cardsJsonBox" style="min-height:160px;" placeholder="æŒ‰åŒ¯å‡ºå¾Œæœƒè‡ªå‹•é¡¯ç¤ºåœ¨é€™è£¡ï¼Œä¹Ÿå¯ç›´æ¥è²¼ä¸Šè¦åŒ¯å…¥çš„ JSON"></textarea>

            <div class="divider"></div>

            <div class="grid2">
              <div>
                <span class="label">é¡å‹</span>
                <select id="newCardType">
                  <option value="chance">æ©Ÿæœƒ</option>
                  <option value="fate">å‘½é‹</option>
                </select>
              </div>
              <div>
                <span class="label">é‡‘é¡ï¼ˆå¯æ­£å¯è² ï¼‰</span>
                <input id="newCardMoney" type="number" placeholder="ä¾‹ï¼š200 æˆ– -300" />
              </div>
            </div>
            <span class="label">å¡ç‰Œå…§å®¹</span>
            <input id="newCardText" placeholder="ä¾‹ï¼šè‡¨æ™‚å¾—åˆ°åœ‹å¤–å–®ä½è³‡æºï½œçœä¸‹ä¸€ç­†æˆæœ¬" />
            <button class="btn ok" id="btnAddCard" style="width:100%;">æ–°å¢å¡ç‰Œ</button>

            <div class="divider"></div>
            <div id="cardsList"></div>
          </div>
        </details>

        <!-- Records -->
        <details open>
          <summary>
            <span>å›ç­”ç´€éŒ„ç‰†</span>
            <span class="pill" id="recordsCountPill">â€”</span>
          </summary>
          <div class="inner">
            <div id="recordsList"></div>
          </div>
        </details>

      </div>
    </section>

  </div>

  <!-- MODAL -->
  <div class="modalBg" id="modalBg" aria-hidden="true">
    <div class="modal" id="modal"></div>
  </div>

<script>
(() => {
  /***********************
   * Board config
   ***********************/
  const CELLS = [
    {id:1,  type:"start",  theme:"â€”",       name:"èµ·é»ï¼ˆç¶“éæ‰£ $200ï¼‰"},
    {id:2,  type:"core",   theme:"å°ç£æ–‡åŒ–", name:"ç¯€æ…¶"},
    {id:3,  type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"æ”¿ç¶“"},
    {id:4,  type:"chance", theme:"â€”",       name:"æ©Ÿæœƒ"},
    {id:5,  type:"core",   theme:"å…¨çƒè¦–é‡", name:"å¤–åœ‹ç¯€æ…¶"},
    {id:6,  type:"core",   theme:"å°ç£æ–‡åŒ–", name:"è‡ªç”±â‘ "},
    {id:7,  type:"fate",   theme:"â€”",       name:"å‘½é‹"},
    {id:8,  type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"æ°¸çºŒ"},
    {id:9,  type:"jail",   theme:"â€”",       name:"ç›£ç„"},
    {id:10, type:"core",   theme:"å…¨çƒè¦–é‡", name:"è‡ªç”±â‘ "},
    {id:11, type:"core",   theme:"å°ç£æ–‡åŒ–", name:"ç¾é£Ÿ"},
    {id:12, type:"chance", theme:"â€”",       name:"æ©Ÿæœƒ"},
    {id:13, type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"è‡ªç”±â‘ "},
    {id:14, type:"core",   theme:"å…¨çƒè¦–é‡", name:"åœ‹å¤–å–®ä½äº¤æµ"},
    {id:15, type:"core",   theme:"å°ç£æ–‡åŒ–", name:"è‡ªç”±â‘¡"},
    {id:16, type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"è‡ªç”±â‘¡"},
    {id:17, type:"core",   theme:"å…¨çƒè¦–é‡", name:"è‡ªç”±â‘¡"},
    {id:18, type:"core",   theme:"å°ç£æ–‡åŒ–", name:"è‡ªç”±â‘¢"},
    {id:19, type:"fate",   theme:"â€”",       name:"å‘½é‹"},
    {id:20, type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"è‡ªç”±â‘¢"},
    {id:21, type:"jail",   theme:"â€”",       name:"ç›£ç„"},
    {id:22, type:"core",   theme:"å…¨çƒè¦–é‡", name:"è‡ªç”±â‘¢"},
  ];

  /***********************
   * âœ… Hotspots (re-tuned)
   * ç‰ˆå‹ï¼šä¸Š8ã€å³5ã€ä¸‹6ã€å·¦3ï¼ˆç¸½å…±22ï¼‰
   * ä½ é‚„æƒ³æ›´ç²¾æº–ï¼šå°±åªæ”¹é€™è£¡çš„ x/yï¼ˆç™¾åˆ†æ¯”ï¼‰
   ***********************/
  const HOTSPOTS = [
    // Top row (1~8)
    {id:1,  x: 14, y: 21},
    {id:2,  x: 26, y: 21},
    {id:3,  x: 38, y: 21},
    {id:4,  x: 50, y: 21},
    {id:5,  x: 62, y: 21},
    {id:6,  x: 74, y: 21},
    {id:7,  x: 86, y: 21},
    {id:8,  x: 94, y: 21},

    // Right column (9~13)
    {id:9,  x: 94, y: 34},
    {id:10, x: 94, y: 46},
    {id:11, x: 94, y: 58},
    {id:12, x: 94, y: 70},
    {id:13, x: 94, y: 82},

    // Bottom row (14~19) right -> left
    {id:14, x: 86, y: 92},
    {id:15, x: 74, y: 92},
    {id:16, x: 62, y: 92},
    {id:17, x: 50, y: 92},
    {id:18, x: 38, y: 92},
    {id:19, x: 26, y: 92},

    // Left column (20~22) bottom -> top
    {id:20, x: 14, y: 82},
    {id:21, x: 14, y: 62},
    {id:22, x: 14, y: 42},
  ];

  /***********************
   * Original cards
   ***********************/
  function rid(prefix){ return prefix + Math.random().toString(16).slice(2,10); }
  const ORIGINAL_CARDS = {
    chance: [
      {money:+300, text:"ä½ è¢«é¸ç‚ºæ›¸é™¢ä»£è¡¨ï¼šææ¡ˆç²é¸ä»£è¡¨æ›¸é™¢ç°¡å ±ï¼Œå…¨å ´æ³¨ç›®ï¼"},
      {money:+200, text:"ç¤¾ç¾¤è²¼æ–‡çˆ†ç´…ï¼šè²¼æ–‡è¢«ç˜‹å‚³ï¼ŒæˆåŠŸå®£å‚³æ´»å‹•ã€‚"},
      {money:+200, text:"çµ„å“¡ä¸»å‹•åˆ†æ“”å·¥ä½œï¼šæœ‰äººåˆ†æ”¤ä»»å‹™ï¼Œè¼•é¬†è¨±å¤šã€‚"},
      {money:+300, text:"æˆåŠŸè«‡å¦¥è´ŠåŠ©ï¼šæ‹¿ä¸‹å¤–éƒ¨å–®ä½æ”¯æŒï¼"},
      {money:+100, text:"ä½ æ‹¿åˆ°å¤–äº¤éƒ¨å‡ºåœ‹è£œåŠ©ï¼šã€Œæœ¬æœˆä¹‹æ˜Ÿã€ç™»ä¸Šå…¬å‘Šæ¬„ã€‚"},
      {money:+300, text:"åœ˜éšŠå°å¤–åƒè³½ç²çï¼šè¬çœ¾çŸšç›®ï¼å¤©ä¸‹ä¹‹å…‰ï¼"},
      {money:+200, text:"è¢«é‚€è«‹åƒèˆ‡å¤–éƒ¨åŸ¹è¨“ï¼šä½ ç²å¾—é€²ä¿®æ©Ÿæœƒã€‚"},
      {money:+100, text:"çµäº¤å¤–åœ‹æœ‹å‹ï¼šé–‹æ‹“è¦–é‡/æ‰“ç ´åˆ»æ¿å°è±¡ã€‚"},
      {money:+300, text:"æ´»å‹•ç²åª’é«”å ±å°ï¼šæ›å…‰åº¦èˆ‡ä¿¡å¿ƒé›™å‡ã€‚"},
      {money:+200, text:"ä½ çš„ææ¡ˆè¢«æ¡ç´ï¼šå‰µæ„æˆç‚ºæ›¸é™¢äº®é»ã€‚"},
      {money:+100, text:"èªè­˜å­¸é•·å§çš„å…§ç·šï¼šç²å–å¯¶è²´è³‡è¨Šã€‚"},
      {money:+200, text:"æ—©é³¥å ±åçˆ†æ»¿ï¼šå ±åäººæ½®è¶…ä¹é æœŸï¼"},
      {money:+300, text:"èˆ‡å°å¸«åŒ–è§£èª¤æœƒï¼šé‡ç²ä¿¡ä»»èˆ‡æ”¯æŒã€‚"},
      {money:+100, text:"åˆ¥äººè¨˜ä½ä½ çš„åŠªåŠ›ï¼šæ„Ÿè¬ä¿¡è®“ä½ æš–å¿ƒã€‚"},
      {money:+300, text:"æ–°æˆå“¡å¸¶ä¾†éˆæ„Ÿï¼šçªç ´åœ˜éšŠå¡é—œï¼"},
      {money:+200, text:"ç²é¸å„ªè‰¯é™¢ç”Ÿï¼šå‰¯æ ¡é•·è¦ªé ’çç‹€+çé‡‘ï¼"},
    ],
    fate: [
      {money:-300, text:"è¢«èª¤æœƒæå…§é¬¥ï¼šæµè¨€å››èµ·ï¼Œå£“åŠ›å€å¢ã€‚"},
      {money:-200, text:"æ´»å‹•å¸³å‹™å‡ºéŒ¯ï¼šå ±å¸³é‡‘é¡é­é€€å›ã€‚"},
      {money:-300, text:"ä¸ç¬¦æ•™è‚²å’Œå­¸ç¿’æ„æ¶µï¼šè¨ˆç•«è¢«é€€å›ä¿®æ”¹ã€‚"},
      {money:-100, text:"çµ„å“¡èººåˆ†ï¼šç¨è‡ªä¸€äººç¡¬æ’ã€‚"},
      {money:-300, text:"è² é¢ç¶²è·¯è¼¿è«–ï¼šç ´å£å¤©ä¸‹è²è­½ã€‚"},
      {money:-200, text:"æ´»å‹•ä¸»æŒäººæ²’æ§å ´ï¼šç¾å ´ä¸€ç‰‡æ··äº‚ã€‚"},
      {money:-100, text:"çµ„å“¡ç™¼èµ·æŠ•è¨´ï¼šå°å¸«æ‰¾ä½ è«‡è©±ã€‚"},
      {money:-300, text:"é¢±é¢¨ä¾†è¥²/è¨­å‚™å£æ‰/å ´åœ°å‡ºåŒ…ï¼šæ´»å‹•ç·Šæ€¥ä¸­æ–·ï¼"},
      {money:-300, text:"è¨ˆç•«èˆ‡åŸææ¡ˆå·®ç•°å¤ªå¤§ï¼šè¦æè¨ˆç•«è®Šæ›´é‡å¯©ã€‚"},
      {money:-200, text:"æ²’æœ‰å ´å¾©ï¼šå‹å‹•æœå‹™+å®³å¤©ä¸‹è¢«åœæ­¢å€Ÿç”¨ã€‚"},
      {money:-300, text:"é­é‡ä¸æ˜è¬ è¨€ï¼šç„¡æ³•æ¾„æ¸…çš„ç„¦æ…®ã€‚"},
      {money:-200, text:"çµ„å“¡å¤±è¯ï¼šåœ˜éšŠé€²åº¦å¡é—œã€‚"},
      {money:-300, text:"æ–°è¦å®šé™åˆ¶å½¢å¼ï¼šæ´»å‹•å—æ”¿ç­–ç‰½åˆ¶ã€‚"},
      {money:-200, text:"ç¶“è²»è¢«ç ï¼šæ²’éŒ¢å–è¥¿åŒ—é¢¨ã€‚"},
      {money:-300, text:"è³‡æ–™éºå¤±ï¼šæª”æ¡ˆå…¨æ¯€ï¼Œé€²åº¦é‡ä¾†ã€‚"},
    ]
  };

  /***********************
   * State
   ***********************/
  const LS_KEY = "nthu_gp_consensus_monopoly_vFULL_20260219";
  function nowStr(){
    const d=new Date(); const p=n=>String(n).padStart(2,"0");
    return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
  }
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  const defaultState = () => ({
    version: 200,
    rules: {
      startMoney: 1000,      // âœ… ä½ è¦çš„é è¨­ 1000ï¼ˆä»å¯æ‰‹å‹•æ”¹ï¼‰
      passStartCost: 200,
      bailCost: 100,
      rentPerBuilding: 200,
      landValue: 300,
      buildingBonus: 50,
      maxBuildings: 9
    },
    activeTeamIndex: 0,
    teams: [],
    ownership: {
      // cellId: { owners: {teamId: buildings}, planIds: [] }
      // âœ… å…±å‰µ/å¤šæ£Ÿï¼šowners æŒ‰æ¯”ä¾‹åˆ†ç§Ÿ
    },
    plans: [],
    records: [],
    jail: {}, // teamId: {skip: 0/1}
    cards: {
      chance: ORIGINAL_CARDS.chance.map(c => ({id: rid("C"), ...c})),
      fate: ORIGINAL_CARDS.fate.map(c => ({id: rid("F"), ...c})),
    },
    finished: false
  });

  let STATE = loadState();
  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      if(!s || s.version !== 200) return defaultState();
      if(!s.cards?.chance || !s.cards?.fate){
        s.cards = {
          chance: ORIGINAL_CARDS.chance.map(c => ({id: rid("C"), ...c})),
          fate: ORIGINAL_CARDS.fate.map(c => ({id: rid("F"), ...c})),
        };
      }
      if(!Array.isArray(s.records)) s.records=[];
      if(!Array.isArray(s.plans)) s.plans=[];
      if(!s.ownership) s.ownership={};
      if(!s.jail) s.jail={};
      if(typeof s.finished !== "boolean") s.finished=false;
      if(!s.rules?.startMoney) s.rules = defaultState().rules;
      return s;
    }catch(e){
      return defaultState();
    }
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(STATE)); }

  function cellById(id){ return CELLS.find(c=>c.id===id); }
  function cellLabel(id){
    const c = cellById(id);
    if(!c) return `æ ¼å­${id}`;
    return c.theme !== "â€”" ? `${c.theme}ï¼${c.name}` : c.name;
  }
  function getActiveTeam(){ return STATE.teams[STATE.activeTeamIndex] || null; }

  function clampMoney(team){
    // âœ… ä½ èªªï¼šmoney < 0 å°±çµæŸï¼Œä½†ã€Œç­‰æ–¼ 0 é‚„å¯ä»¥ç¹¼çºŒã€
    if(team.money < 0){
      STATE.finished = true;
    }
  }

  function ownedCount(teamId){
    let n=0;
    for(const k of Object.keys(STATE.ownership)){
      const o = STATE.ownership[k];
      if(o?.owners && o.owners[teamId]) n++;
    }
    return n;
  }

  /***********************
   * DOM
   ***********************/
  const elStatusLine = document.getElementById("statusLine");
  const elTeamsCountPill = document.getElementById("teamsCountPill");
  const elCardsCountPill = document.getElementById("cardsCountPill");
  const elRecordsCountPill = document.getElementById("recordsCountPill");

  const elSelActiveTeam = document.getElementById("selActiveTeam");
  const elTurnInfo = document.getElementById("turnInfo");

  const elTeamsList = document.getElementById("teamsList");
  const elCardsList = document.getElementById("cardsList");
  const elRecordsList = document.getElementById("recordsList");

  const elMapWrap = document.getElementById("mapWrap");

  const modalBg = document.getElementById("modalBg");
  const modal = document.getElementById("modal");
  modalBg.addEventListener("click", () => { /* no-op */ });

  function openModal(html){
    modal.innerHTML = html;
    modalBg.style.display = "flex";
    modalBg.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modalBg.style.display = "none";
    modalBg.setAttribute("aria-hidden","true");
    modal.innerHTML = "";
  }

  function stripHtmlToText(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    return (tmp.textContent || tmp.innerText || "").trim();
  }

  /***********************
   * Records (only answers)
   ***********************/
  function pushRecord(type, title, html, meta={}){
    STATE.records.unshift({id: rid("R"), t: nowStr(), type, title, html, meta});
    saveState();
    render();
  }

  /***********************
   * Map tokens/dots
   ***********************/
  function buildMap(){
    [...elMapWrap.querySelectorAll(".token")].forEach(n=>n.remove());
    [...elMapWrap.querySelectorAll(".cellDot")].forEach(n=>n.remove());

    for(const h of HOTSPOTS){
      const dot = document.createElement("div");
      dot.className = "cellDot";
      dot.style.left = `${h.x}%`;
      dot.style.top  = `${h.y}%`;
      elMapWrap.appendChild(dot);
    }

    for(const t of STATE.teams){
      const h = HOTSPOTS.find(x=>x.id===t.position) || HOTSPOTS[0];
      const tok = document.createElement("div");
      tok.className = "token";
      tok.style.left = `${h.x}%`;
      tok.style.top  = `${h.y}%`;
      tok.style.background = t.color;
      tok.title = `${t.name} @ ${cellLabel(t.position)}`;
      elMapWrap.appendChild(tok);
    }
  }

  /***********************
   * Render
   ***********************/
  function render(){
    elStatusLine.textContent =
      `éšŠä¼ ${STATE.teams.length}ï½œä¼åŠƒ ${STATE.plans.length}ï½œå›ç­” ${STATE.records.length}ï½œæ©Ÿæœƒ ${STATE.cards.chance.length}ï½œå‘½é‹ ${STATE.cards.fate.length}`;

    elTeamsCountPill.textContent = `éšŠä¼ ${STATE.teams.length}`;
    elCardsCountPill.textContent = `æ©Ÿæœƒ ${STATE.cards.chance.length}ï½œå‘½é‹ ${STATE.cards.fate.length}`;
    elRecordsCountPill.textContent = `è¨˜éŒ„ ${STATE.records.length}`;

    // Active select
    elSelActiveTeam.innerHTML = "";
    STATE.teams.forEach((t, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `${t.name}ï¼ˆ$${t.money}ï½œ${cellLabel(t.position)}ï¼‰`;
      elSelActiveTeam.appendChild(opt);
    });

    if(STATE.teams.length > 0){
      elSelActiveTeam.value = String(STATE.activeTeamIndex);
      const t = getActiveTeam();
      const jail = STATE.jail[t.id];
      elTurnInfo.textContent = jail?.skip ? `ç›£ç„ï¼šè·³é 1 å›åˆ` : `è¼ªåˆ°ï¼š${t.name}`;
    }else{
      elTurnInfo.textContent = "è«‹å…ˆæ–°å¢éšŠä¼";
    }

    // Teams list
    elTeamsList.innerHTML = "";
    STATE.teams.forEach((t, idx) => {
      const jail = STATE.jail[t.id];
      const active = idx===STATE.activeTeamIndex;

      const div = document.createElement("div");
      div.className = "teamItem";
      div.innerHTML = `
        <div>
          <div class="teamName">
            <span style="width:10px;height:10px;border-radius:999px;background:${t.color};display:inline-block;"></span>
            ${escapeHtml(t.name)}
            ${active ? `<span class="tag" style="border-color:rgba(255,107,155,.35);background:rgba(255,107,155,.14)">ç›®å‰</span>` : ""}
            ${jail?.skip ? `<span class="tag" style="border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.12)">ç›£ç„è·³é1</span>` : ""}
          </div>
          <div class="mini">
            æˆå“¡ï¼š${escapeHtml(t.members||"â€”")}ï½œç¾é‡‘ï¼š$${t.money}
            <br>ä½ç½®ï¼š${escapeHtml(cellLabel(t.position))}ï½œåœ°ç”¢ï¼š${ownedCount(t.id)} æ ¼
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn" data-act="setActive" data-idx="${idx}">åˆ‡æ›</button>
          <button class="btn bad" data-act="removeTeam" data-id="${t.id}">åˆªé™¤</button>
        </div>
      `;
      elTeamsList.appendChild(div);
    });

    // Cards list
    elCardsList.innerHTML = "";

    const addCardGroupTitle = (label) => {
      const d = document.createElement("div");
      d.className = "tag";
      d.textContent = label;
      d.style.marginBottom="8px";
      elCardsList.appendChild(d);
    };

    const addCardDetails = (type, c) => {
      const dd = document.createElement("details");
      dd.className = "cardDetails";
      dd.innerHTML = `
        <summary>
          <span>${type==="chance"?"æ©Ÿæœƒ":"å‘½é‹"}ï½œ${c.money>=0?"+":""}${c.money}</span>
          <span class="tag">é»é–‹çœ‹å…¨æ–‡</span>
        </summary>
        <div class="body">${escapeHtml(c.text)}</div>
        <div class="body" style="padding-top:0;">
          <button class="btn bad" data-act="delCard" data-type="${type}" data-id="${c.id}">åˆªé™¤</button>
        </div>
      `;
      elCardsList.appendChild(dd);
    };

    addCardGroupTitle("æ©Ÿæœƒå¡");
    STATE.cards.chance.forEach(c => addCardDetails("chance", c));
    addCardGroupTitle("å‘½é‹å¡");
    STATE.cards.fate.forEach(c => addCardDetails("fate", c));

    // Records list
    elRecordsList.innerHTML = "";
    if(STATE.records.length===0){
      const m = document.createElement("div");
      m.className = "pill";
      m.textContent = "ç›®å‰é‚„æ²’æœ‰å›ç­”ç´€éŒ„";
      elRecordsList.appendChild(m);
    }else{
      STATE.records.forEach(r => {
        const dd = document.createElement("details");
        dd.className = "recordDetails";
        dd.innerHTML = `
          <summary>
            <span>${r.t}ï½œ${escapeHtml(r.title)}</span>
            <span class="tag">${escapeHtml(r.type)}</span>
          </summary>
          <div class="body">${stripHtmlToText(r.html)}</div>
        `;
        elRecordsList.appendChild(dd);
      });
    }

    buildMap();
  }

  /***********************
   * Teams
   ***********************/
  function pickColor(i){
    const palette = ["#ff6b9b","#60a5fa","#22c55e","#f59e0b","#a78bfa","#fb7185","#34d399","#f472b6","#93c5fd"];
    return palette[i % palette.length];
  }

  function addTeam(){
    const name = document.getElementById("teamName").value.trim() || `ç¬¬ ${STATE.teams.length+1} çµ„`;
    const members = document.getElementById("teamMembers").value.trim();
    const money = parseInt(document.getElementById("teamMoney").value, 10);
    const startMoney = Number.isFinite(money) ? money : STATE.rules.startMoney;

    const team = {
      id: rid("T"),
      name,
      members,
      money: startMoney,
      position: 1,
      color: pickColor(STATE.teams.length)
    };
    STATE.teams.push(team);
    saveState();
    document.getElementById("teamName").value = "";
    document.getElementById("teamMembers").value = "";
    render();
  }

  function removeTeam(teamId){
    for(const k of Object.keys(STATE.ownership)){
      const o = STATE.ownership[k];
      if(o?.owners && o.owners[teamId]){
        delete o.owners[teamId];
        if(Object.keys(o.owners).length===0) delete STATE.ownership[k];
      }
    }
    delete STATE.jail[teamId];
    STATE.teams = STATE.teams.filter(t => t.id !== teamId);
    if(STATE.activeTeamIndex >= STATE.teams.length) STATE.activeTeamIndex = 0;
    saveState();
    render();
  }

  function shuffleTeams(){
    if(STATE.teams.length <= 1) return;
    // Fisherâ€“Yates
    for(let i=STATE.teams.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [STATE.teams[i], STATE.teams[j]] = [STATE.teams[j], STATE.teams[i]];
    }
    STATE.activeTeamIndex = 0;
    saveState();
    render();
  }

  /***********************
   * Cards library import/export (textarea + file)
   ***********************/
  const cardsJsonBox = document.getElementById("cardsJsonBox");

  function addCard(){
    const type = document.getElementById("newCardType").value;
    const text = document.getElementById("newCardText").value.trim();
    const money = Number(document.getElementById("newCardMoney").value);

    if(!text || !Number.isFinite(money)){
      openModal(`
        <div class="modalTop"><h3>æ–°å¢å¡ç‰Œå¤±æ•—</h3><span class="pill">INFO</span></div>
        <div class="modalHint">è«‹å¡«å¯«å¡ç‰Œå…§å®¹èˆ‡é‡‘é¡ï¼ˆå¯æ­£å¯è² ï¼‰ã€‚</div>
        <div class="modalFooter"><button class="btn ok" id="mOk">çŸ¥é“äº†</button></div>
      `);
      document.getElementById("mOk").onclick = () => closeModal();
      return;
    }
    const id = rid(type==="chance"?"C":"F");
    STATE.cards[type].push({id, text, money});
    document.getElementById("newCardText").value = "";
    document.getElementById("newCardMoney").value = "";
    saveState();
    render();
  }

  function deleteCard(type, id){
    STATE.cards[type] = STATE.cards[type].filter(c => c.id !== id);
    saveState();
    render();
  }

  function getCardsPayload(){
    return {
      version: 1,
      exportedAt: new Date().toISOString(),
      chance: STATE.cards.chance.map(c => ({money: c.money, text: c.text})),
      fate: STATE.cards.fate.map(c => ({money: c.money, text: c.text}))
    };
  }

  function exportCardsJson(){
    const payload = getCardsPayload();
    const json = JSON.stringify(payload, null, 2);
    cardsJsonBox.value = json;

    const blob = new Blob([json], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `å¡ç‰Œåº«_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function parseCardsFromText(text){
    const data = JSON.parse(text);
    const chance = Array.isArray(data.chance) ? data.chance : [];
    const fate = Array.isArray(data.fate) ? data.fate : [];
    const normChance = chance
      .filter(x => typeof x.text === "string" && Number.isFinite(Number(x.money)))
      .map(x => ({id: rid("C"), text: String(x.text), money: Number(x.money)}));
    const normFate = fate
      .filter(x => typeof x.text === "string" && Number.isFinite(Number(x.money)))
      .map(x => ({id: rid("F"), text: String(x.text), money: Number(x.money)}));
    return {chance: normChance, fate: normFate};
  }

  function importCardsFromTextarea({mode}){
    const raw = cardsJsonBox.value.trim();
    if(!raw){
      openModal(`
        <div class="modalTop"><h3>åŒ¯å…¥å¤±æ•—</h3><span class="pill">ERROR</span></div>
        <div class="modalHint">æ–‡å­—æ¡†æ²’æœ‰å…§å®¹ã€‚</div>
        <div class="modalFooter"><button class="btn ok" id="mOk">çŸ¥é“äº†</button></div>
      `);
      document.getElementById("mOk").onclick = () => closeModal();
      return;
    }
    try{
      const parsed = parseCardsFromText(raw);
      if(mode==="replace"){
        STATE.cards.chance = parsed.chance;
        STATE.cards.fate = parsed.fate;
      }else{
        STATE.cards.chance.push(...parsed.chance);
        STATE.cards.fate.push(...parsed.fate);
      }
      saveState();
      render();
      openModal(`
        <div class="modalTop"><h3>åŒ¯å…¥æˆåŠŸ</h3><span class="pill">OK</span></div>
        <div class="modalHint">æ©Ÿæœƒ ${STATE.cards.chance.length}ï½œå‘½é‹ ${STATE.cards.fate.length}</div>
        <div class="modalFooter"><button class="btn ok" id="mOk">çŸ¥é“äº†</button></div>
      `);
      document.getElementById("mOk").onclick = () => closeModal();
    }catch(e){
      openModal(`
        <div class="modalTop"><h3>åŒ¯å…¥å¤±æ•—</h3><span class="pill">ERROR</span></div>
        <div class="modalHint">JSON æ ¼å¼ä¸åˆæ³•æˆ–æ¬„ä½ä¸ç¬¦åˆã€‚</div>
        <div class="modalFooter"><button class="btn ok" id="mOk">çŸ¥é“äº†</button></div>
      `);
      document.getElementById("mOk").onclick = () => closeModal();
    }
  }

  function importCardsJsonFromFile(file, {mode}){
    const reader = new FileReader();
    reader.onload = () => {
      cardsJsonBox.value = String(reader.result || "");
      importCardsFromTextarea({mode});
    };
    reader.readAsText(file, "utf-8");
  }

  /***********************
   * Game flow helpers
   ***********************/
  function rollDice(){ return Math.floor(Math.random()*6)+1; }

  function moveTeam(team, steps){
    let pos = team.position;
    for(let i=0;i<steps;i++){
      pos++;
      if(pos>22) pos = 1;
      if(pos===1){
        team.money -= STATE.rules.passStartCost;
        clampMoney(team);
      }
    }
    team.position = pos;
  }

  function nextTeam(){
    if(STATE.teams.length===0) return;
    STATE.activeTeamIndex = (STATE.activeTeamIndex + 1) % STATE.teams.length;
    saveState();
    render();
  }

  function autoSkipIfJailed(){
    const t = getActiveTeam();
    if(!t) return false;
    const j = STATE.jail[t.id];
    if(j?.skip){
      STATE.jail[t.id].skip = 0;
      saveState();
      render();
      nextTeam();
      return true;
    }
    return false;
  }

  function drawCard(type){
    const arr = type==="chance" ? STATE.cards.chance : STATE.cards.fate;
    if(!arr.length) return null;
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function getPlansForCell(cellId){
    const own = STATE.ownership[String(cellId)];
    const ids = own?.planIds || [];
    return ids.map(pid => STATE.plans.find(p => p.id===pid)).filter(Boolean);
  }

  function plansHtml(plans){
    if(!plans.length) return `<div class="pill">ï¼ˆæ­¤æ ¼å°šç„¡æ—¢æœ‰ä¼åŠƒå¡ï¼‰</div>`;
    return plans.map((p,i) => `
      <div style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.16);margin-top:8px;">
        <div style="font-weight:950;">æ—¢æœ‰ä¼åŠƒ #${i+1}ï½œ${escapeHtml(p.name)}</div>
        ${p.slogan ? `<div><b>äº®é»ï¼š</b>${escapeHtml(p.slogan)}</div>` : ""}
        ${p.WHO ? `<div><b>WHOï¼š</b>${escapeHtml(p.WHO)}</div>` : ""}
        ${p.WHAT ? `<div><b>WHATï¼š</b>${escapeHtml(p.WHAT)}</div>` : ""}
        ${p.HOW ? `<div><b>HOWï¼š</b>${escapeHtml(p.HOW)}</div>` : ""}
        ${p.WHY ? `<div><b>WHYï¼š</b>${escapeHtml(p.WHY)}</div>` : ""}
        ${p.said ? `<div><b>ä»–å€‘èªªäº†ä»€éº¼ï¼š</b>${escapeHtml(p.said)}</div>` : ""}
        <div class="divider"></div>
        <div class="pill">æŠ•ç¥¨ï¼šYES ${p.vote?.yes ?? "?"}/${p.vote?.total ?? "?"} â†’ ${p.result==="PASS"?"é€šé":"æœªé€šé"}</div>
      </div>
    `).join("");
  }

  /***********************
   * Rent (æ¯”ä¾‹åˆ†é…)
   * è¸©åˆ°è€…ä»˜ 200 * ç¸½æ£Ÿæ•¸
   * owners: {teamId: buildings}
   ***********************/
  function distributeRent(payerTeam, cellId){
    const own = STATE.ownership[String(cellId)];
    if(!own?.owners) return 0;

    const owners = own.owners;
    const totalBuildings = Object.values(owners).reduce((a,b)=>a+(b||0),0) || 0;
    if(totalBuildings<=0) return 0;

    const rent = STATE.rules.rentPerBuilding * totalBuildings;
    payerTeam.money -= rent;
    clampMoney(payerTeam);

    // åˆ†é…
    for(const teamId of Object.keys(owners)){
      const b = owners[teamId] || 0;
      const portion = Math.round((rent * b) / totalBuildings);
      const t = STATE.teams.find(x=>x.id===teamId);
      if(t) t.money += portion;
    }

    saveState();
    render();
    return rent;
  }

  /***********************
   * Modals
   ***********************/
  function showDiceModal(team, dice, destLabel){
    return new Promise(resolve => {
      openModal(`
        <div class="modalTop"><h3>æ“²éª°çµæœ</h3><span class="pill">DICE</span></div>
        <div class="modalHero">
          <div class="d">ğŸ² ${dice}</div>
          <div class="to">${escapeHtml(team.name)} â†’ ${escapeHtml(destLabel)}</div>
        </div>
        <div class="modalFooter"><button class="btn ok" id="mGo">ç¹¼çºŒ</button></div>
      `);
      document.getElementById("mGo").onclick = () => { closeModal(); resolve(); };
    });
  }

  function infoModal(title, html, pill="INFO"){
    return new Promise(resolve => {
      openModal(`
        <div class="modalTop"><h3>${escapeHtml(title)}</h3><span class="pill">${escapeHtml(pill)}</span></div>
        <div class="modalHint">${html}</div>
        <div class="modalFooter"><button class="btn ok" id="mOk">ç¢ºå®š</button></div>
      `);
      document.getElementById("mOk").onclick = () => { closeModal(); resolve(); };
    });
  }

  function themeTag(theme){
    if(theme==="å°ç£æ–‡åŒ–") return `<span class="tag" style="border-color:rgba(255,107,155,.35);background:rgba(255,107,155,.14)">å°ç£æ–‡åŒ–</span>`;
    if(theme==="åœ‹éš›è­°é¡Œ") return `<span class="tag" style="border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.14)">åœ‹éš›è­°é¡Œ</span>`;
    if(theme==="å…¨çƒè¦–é‡") return `<span class="tag" style="border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.14)">å…¨çƒè¦–é‡</span>`;
    return `<span class="tag">ç‰¹æ®Š</span>`;
  }

  /***********************
   * Plan modal (å¯«ä¼åŠƒ/æŠ•ç¥¨)
   ***********************/
  function planModal({team, cell, mode, previousPlans}){
    return new Promise(resolve => {
      const total = STATE.teams.length;
      const votesByTeam = {};
      STATE.teams.forEach(t => votesByTeam[t.id]="yes");

      openModal(`
        <div class="modalTop">
          <h3>${mode==="buyNew"?"å¯«ä¼åŠƒï¼ˆè²·åœ°ï¼‰":mode==="coCreate"?"å»¶ä¼¸å…±å‰µï¼ˆåŠ è“‹ï¼‰":"åŠ è“‹ï¼ˆè‡ªå·±ï¼‰"}ï½œ${escapeHtml(team.name)}ï¼ ${escapeHtml(cellLabel(cell.id))}</h3>
          <span class="pill">PLAN</span>
        </div>

        <div class="modalHint">${themeTag(cell.theme)}</div>

        ${ (mode==="coCreate") ? `
          <div class="divider"></div>
          <div class="modalHint"><b>æ—¢æœ‰ä¼åŠƒï¼ˆå‰äººå›ç­”ï¼‰</b></div>
          ${plansHtml(previousPlans)}
          <div class="divider"></div>
        ` : `<div class="divider"></div>`}

        <div class="grid2">
          <div>
            <span class="label">ä¼åŠƒåç¨±</span>
            <input id="pName" placeholder="ä¾‹ï¼šä¸–ç•Œæ–‡åŒ–å¤œå¸‚ / äººæ¬Šæ¡ŒéŠå·¥ä½œåŠ..." />
          </div>
          <div>
            <span class="label">ä¸€å¥äº®é»</span>
            <input id="pSlogan" placeholder="ä¾‹ï¼šæŠŠä¸–ç•Œå¸¶é€²å¤©ä¸‹ï¼ŒæŠŠå¤©ä¸‹æ¨å‘ä¸–ç•Œã€‚" />
          </div>
        </div>

        <span class="label">WHOï¼ˆå°è±¡ï¼‰</span>
        <textarea id="pWHO"></textarea>

        <span class="label">WHATï¼ˆå½¢å¼èˆ‡å…§å®¹ï¼‰</span>
        <textarea id="pWHAT"></textarea>

        <span class="label">HOWï¼ˆæµç¨‹èˆ‡è³‡æºï¼‰</span>
        <textarea id="pHOW"></textarea>

        <span class="label">WHYï¼ˆæ ¸å¿ƒå°é½Šï¼‰</span>
        <textarea id="pWHY"></textarea>

        <span class="label">ä»–å€‘èªªäº†ä»€éº¼ï¼ˆç™¼è¨€ç´€éŒ„ï¼‰</span>
        <textarea id="pSaid"></textarea>

        <div class="divider"></div>
        <div class="modalHint"><b>æŠ•ç¥¨ï¼ˆéåŠé€šéï¼‰</b></div>
        <div class="row" id="voteRow" style="margin-top:8px; align-items:flex-start;"></div>

        <div class="modalFooter">
          <button class="btn ok" id="mSubmit">é€å‡º</button>
        </div>
      `);

      const voteRow = document.getElementById("voteRow");
      STATE.teams.forEach(t => {
        const wrap = document.createElement("div");
        wrap.style.display="flex";
        wrap.style.gap="8px";
        wrap.style.flexWrap="wrap";
        wrap.style.margin="0 10px 10px 0";

        const yes = document.createElement("button");
        yes.className = "btn ok";
        yes.textContent = `${t.name}ï¼šYES`;

        const no = document.createElement("button");
        no.className = "btn";
        no.textContent = `${t.name}ï¼šNO`;

        yes.onclick = () => { votesByTeam[t.id]="yes"; yes.className="btn ok"; no.className="btn"; };
        no.onclick  = () => { votesByTeam[t.id]="no";  no.className="btn bad"; yes.className="btn"; };

        wrap.appendChild(yes);
        wrap.appendChild(no);
        voteRow.appendChild(wrap);
      });

      document.getElementById("mSubmit").onclick = async () => {
        const plan = {
          id: rid("P"),
          teamId: team.id,
          cellId: cell.id,
          cellLabel: cellLabel(cell.id),
          theme: cell.theme,
          mode,
          name: (document.getElementById("pName").value.trim() || `æœªå‘½åä¼åŠƒï¼ˆ${cellLabel(cell.id)}ï¼‰`),
          slogan: document.getElementById("pSlogan").value.trim(),
          WHO: document.getElementById("pWHO").value.trim(),
          WHAT: document.getElementById("pWHAT").value.trim(),
          HOW: document.getElementById("pHOW").value.trim(),
          WHY: document.getElementById("pWHY").value.trim(),
          said: document.getElementById("pSaid").value.trim(),
          votesByTeam,
          createdAt: new Date().toISOString()
        };

        let yesN=0;
        for(const k in votesByTeam) if(votesByTeam[k]==="yes") yesN++;
        const passed = yesN > total/2;
        plan.vote = {yes: yesN, no: total-yesN, total};
        plan.result = passed ? "PASS" : "FAIL";

        STATE.plans.unshift(plan);

        // âœ… è¨˜éŒ„ç‰†ï¼šåªè¨˜å›ç­”
        const html = `
          <div><b>æ ¼å­ï¼š</b>${escapeHtml(plan.cellLabel)} ${themeTag(plan.theme)}</div>
          <div><b>ä¼åŠƒï¼š</b>${escapeHtml(plan.name)}</div>
          ${plan.slogan ? `<div><b>äº®é»ï¼š</b>${escapeHtml(plan.slogan)}</div>` : ""}
          ${plan.WHO ? `<div><b>WHOï¼š</b>${escapeHtml(plan.WHO)}</div>` : ""}
          ${plan.WHAT ? `<div><b>WHATï¼š</b>${escapeHtml(plan.WHAT)}</div>` : ""}
          ${plan.HOW ? `<div><b>HOWï¼š</b>${escapeHtml(plan.HOW)}</div>` : ""}
          ${plan.WHY ? `<div><b>WHYï¼š</b>${escapeHtml(plan.WHY)}</div>` : ""}
          ${plan.said ? `<div><b>ä»–å€‘èªªäº†ä»€éº¼ï¼š</b>${escapeHtml(plan.said)}</div>` : ""}
          <div class="divider"></div>
          <div><b>æŠ•ç¥¨ï¼š</b>YES ${yesN}/${total} â†’ ${passed ? "âœ… é€šé" : "âŒ æœªé€šé"}</div>
        `;
        pushRecord("ä¼åŠƒå¡", `${team.name}ï½œ${passed ? "é€šé" : "æœªé€šé"}`, html, {planId: plan.id});

        // âœ… åœŸåœ°/åŠ è“‹è¦å‰‡
        const key = String(cell.id);
        if(passed){
          // ç¢ºä¿ ownership çµæ§‹å­˜åœ¨
          if(!STATE.ownership[key]){
            STATE.ownership[key] = { owners: {}, planIds: [] };
          }
          STATE.ownership[key].planIds = STATE.ownership[key].planIds || [];
          STATE.ownership[key].planIds.push(plan.id);

          // buyNewï¼šçµ¦ 1 æ£Ÿ
          if(mode==="buyNew"){
            STATE.ownership[key].owners[team.id] = (STATE.ownership[key].owners[team.id] || 0) + 1;
          }

          // coCreateï¼šå…±å‰µã€Œä¸ä»˜ç§Ÿé‡‘ã€ï¼Œç­‰åŒåŠ è“‹ +1ï¼ˆå¢åŠ è‡ªå·±çš„æ£Ÿæ•¸ï¼‰
          if(mode==="coCreate" || mode==="upgradeSelf"){
            STATE.ownership[key].owners[team.id] = (STATE.ownership[key].owners[team.id] || 0) + 1;
          }
        }

        saveState();
        closeModal();

        // âœ… å¦‚æœå…±å‰µä¸é€šéï¼šè¦ä»˜ç§Ÿé‡‘çµ¦æ“æœ‰è€…ï¼ˆä½ è¦æ±‚çš„ï¼‰
        if(!passed && mode==="coCreate"){
          const rent = distributeRent(team, cell.id);
          await infoModal("å…±å‰µæœªé€šéï½œç§Ÿé‡‘çµç®—", `æœªé€šéï¼šéœ€ä»˜ç§Ÿé‡‘ $${rent}ï¼ˆæŒ‰æ£Ÿæ•¸æ¯”ä¾‹åˆ†é…ï¼‰ã€‚`);
        }

        resolve();
      };
    });
  }

  /***********************
   * Landing logic
   ***********************/
  async function handleLanding(team){
    const c = cellById(team.position);

    if(STATE.finished) return;

    if(c.type === "start"){
      return;
    }

    if(c.type === "chance" || c.type === "fate"){
      const card = drawCard(c.type);
      if(!card){
        await infoModal("å¡ç‰Œåº«ç‚ºç©º", `ç›®å‰ ${c.type==="chance"?"æ©Ÿæœƒ":"å‘½é‹"} å¡ç‰Œåº«æ˜¯ç©ºçš„ã€‚`);
        return;
      }
      openModal(`
        <div class="modalTop">
          <h3>${c.type==="chance"?"æ©Ÿæœƒå¡":"å‘½é‹å¡"}</h3><span class="pill">CARD</span>
        </div>
        <div class="modalHint">
          <div style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.16);">
            <div class="row" style="justify-content:space-between;">
              <span>${escapeHtml(card.text)}</span>
              <span class="tag">${card.money>=0?"+":""}${card.money}</span>
            </div>
          </div>
          <div style="margin-top:10px;"><b>ç›®å‰ç¾é‡‘ï¼š</b>$${team.money}</div>
        </div>
        <div class="modalFooter">
          <button class="btn ok" id="mApply">å¥—ç”¨</button>
        </div>
      `);
      await new Promise(resolve => {
        document.getElementById("mApply").onclick = () => {
          team.money += card.money;
          clampMoney(team);
          saveState();
          closeModal();
          resolve();
        };
      });
      return;
    }

    if(c.type === "jail"){
      openModal(`
        <div class="modalTop">
          <h3>ç›£ç„ï½œ${escapeHtml(team.name)}</h3><span class="pill">JAIL</span>
        </div>
        <div class="modalHint">
          ä½ å¿…é ˆé¸æ“‡ï¼š<b>èŠ± $${STATE.rules.bailCost} ä¿é‡‹</b> æˆ– <b>ä¸‹ä¸€å›åˆè·³é</b>
        </div>
        <div class="modalFooter">
          <button class="btn bad" id="mSkip">ä¸‹ä¸€å›åˆè·³é</button>
          <button class="btn ok" id="mBail">èŠ± $${STATE.rules.bailCost} ä¿é‡‹</button>
        </div>
      `);

      await new Promise(resolve => {
        document.getElementById("mSkip").onclick = () => {
          STATE.jail[team.id] = {skip: 1};
          saveState();
          closeModal();
          resolve();
        };
        document.getElementById("mBail").onclick = () => {
          team.money -= STATE.rules.bailCost;
          clampMoney(team);
          STATE.jail[team.id] = {skip: 0};
          saveState();
          closeModal();
          resolve();
        };
      });
      return;
    }

    // CORE
    if(c.type === "core"){
      const key = String(c.id);
      const own = STATE.ownership[key];

      // empty land
      if(!own){
        openModal(`
          <div class="modalTop"><h3>ç©ºåœ°ï½œ${escapeHtml(cellLabel(c.id))}</h3><span class="pill">CORE</span></div>
          <div class="modalHint">${themeTag(c.theme)}</div>
          <div class="modalFooter">
            <button class="btn" id="mPass">åªæ˜¯ç¶“é</button>
            <button class="btn ok" id="mWrite">å¯«ä¼åŠƒè²·åœ°</button>
          </div>
        `);

        const choice = await new Promise(resolve => {
          document.getElementById("mPass").onclick = () => { closeModal(); resolve("pass"); };
          document.getElementById("mWrite").onclick = () => { closeModal(); resolve("write"); };
        });

        if(choice==="write"){
          await planModal({team, cell:c, mode:"buyNew", previousPlans: []});
        }
        return;
      }

      // own land? (has any buildings)
      const myBuildings = own?.owners?.[team.id] || 0;

      if(myBuildings > 0){
        openModal(`
          <div class="modalTop"><h3>è‡ªå·±çš„åœ°ï½œ${escapeHtml(cellLabel(c.id))}</h3><span class="pill">OWN</span></div>
          <div class="modalHint">${themeTag(c.theme)}</div>
          <div class="modalFooter">
            <button class="btn" id="mPass">åªæ˜¯ç¶“é</button>
            <button class="btn ok" id="mUpgrade">åŠ è“‹ï¼ˆéœ€å¯«ä¼åŠƒï¼‹æŠ•ç¥¨ï¼‰</button>
          </div>
        `);

        const choice = await new Promise(resolve => {
          document.getElementById("mPass").onclick = () => { closeModal(); resolve("pass"); };
          document.getElementById("mUpgrade").onclick = () => { closeModal(); resolve("upgrade"); };
        });

        if(choice==="upgrade"){
          // âœ… è‡ªå·±åŠ è“‹ï¼šä¸é€šéä¸éœ€ä»˜éŒ¢ï¼ˆä½ è¦æ±‚ï¼‰
          await planModal({team, cell:c, mode:"upgradeSelf", previousPlans: getPlansForCell(c.id)});
        }
        return;
      }

      // other land (or co-created by others)
      // âœ… ä½ æ–°çš„è¦å‰‡ï¼šæƒ³å…±å‰µã€Œä¸ç”¨å…ˆä»˜ç§Ÿé‡‘ã€
      // ä½†å¦‚æœå…±å‰µä¸é€šé â†’ è¦ä»˜ç§Ÿé‡‘ï¼ˆä½ è¦æ±‚ï¼‰
      const totalBuildings = Object.values(own.owners || {}).reduce((a,b)=>a+(b||0),0) || 0;
      const rent = STATE.rules.rentPerBuilding * totalBuildings;

      openModal(`
        <div class="modalTop"><h3>è¸©åˆ°ä»–äººåœ°ï½œ${escapeHtml(cellLabel(c.id))}</h3><span class="pill">CORE</span></div>
        <div class="modalHint">
          ${themeTag(c.theme)}
          <div style="margin-top:8px;">ç¸½æ£Ÿæ•¸ï¼š<b>${totalBuildings}</b>ï½œç§Ÿé‡‘ï¼š<b>$${rent}</b>ï¼ˆæŒ‰æ£Ÿæ•¸æ¯”ä¾‹åˆ†é…ï¼‰</div>
        </div>
        <div class="modalFooter">
          <button class="btn warn" id="mRent">ä»˜ç§Ÿé‡‘</button>
          <button class="btn ok" id="mCoCreate">å…±å‰µåŠ è“‹ï¼ˆä¸å…ˆä»˜ï¼‰</button>
        </div>
      `);

      const choice = await new Promise(resolve => {
        document.getElementById("mRent").onclick = () => { closeModal(); resolve("rent"); };
        document.getElementById("mCoCreate").onclick = () => { closeModal(); resolve("cocreate"); };
      });

      if(choice==="rent"){
        const paid = distributeRent(team, c.id);
        await infoModal("ç§Ÿé‡‘çµç®—å®Œæˆ", `å·²æ”¯ä»˜ $${paid}ï¼ˆæŒ‰æ£Ÿæ•¸æ¯”ä¾‹åˆ†é…ï¼‰ã€‚`);
        return;
      }

      // cocreate (no upfront). if plan fails => rent will be charged inside planModal
      const prev = getPlansForCell(c.id);
      await planModal({team, cell:c, mode:"coCreate", previousPlans: prev});
      return;
    }
  }

  /***********************
   * Play
   ***********************/
  async function playRoll(){
    if(STATE.finished){
      await infoModal("éŠæˆ²å·²çµæŸ", "money < 0ï¼ˆç ´ç”¢ï¼‰æˆ–å·²çµç®—ã€‚");
      return;
    }
    const team = getActiveTeam();
    if(!team){
      await infoModal("å°šæœªæœ‰éšŠä¼", "è«‹å…ˆæ–°å¢éšŠä¼ã€‚");
      return;
    }

    const skipped = autoSkipIfJailed();
    if(skipped) return;

    const d = rollDice();
    moveTeam(team, d);

    saveState();
    render();

    await showDiceModal(team, d, cellLabel(team.position));

    if(STATE.finished){
      await infoModal("ç ´ç”¢ï½œéŠæˆ²çµæŸ", `${team.name} money < 0ï¼ŒéŠæˆ²çµæŸã€‚`);
      finishAndSettle(true);
      return;
    }

    await handleLanding(team);

    if(STATE.finished){
      await infoModal("ç ´ç”¢ï½œéŠæˆ²çµæŸ", `æœ‰äºº money < 0ï¼ŒéŠæˆ²çµæŸã€‚`);
      finishAndSettle(true);
      return;
    }

    nextTeam();
  }

  /***********************
   * Finish / Settle
   ***********************/
  function finishAndSettle(isForced=false){
    if(STATE.finished && !isForced){
      return;
    }
    STATE.finished = true;

    const {landValue, buildingBonus} = STATE.rules;

    const passesByTeam = {};
    STATE.plans.forEach(p => {
      if(p.result==="PASS"){
        passesByTeam[p.teamId] = (passesByTeam[p.teamId] || 0) + 1;
      }
    });

    const rows = STATE.teams.map(t => {
      let ownedCells=0;
      let buildings=0;
      for(const k of Object.keys(STATE.ownership)){
        const o = STATE.ownership[k];
        const b = o?.owners?.[t.id] || 0;
        if(b>0){
          ownedCells++;
          buildings += b;
        }
      }
      const asset = t.money + ownedCells*landValue + buildings*buildingBonus;
      return {
        teamId:t.id,
        name:t.name,
        money:t.money,
        ownedCells,
        buildings,
        passPlans: passesByTeam[t.id] || 0,
        asset
      };
    }).sort((a,b)=>b.asset-a.asset);

    const html = `
      ${rows.map((r,i)=>`
        <div style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.16);margin-top:8px;">
          <div style="font-weight:990;">#${i+1} ${escapeHtml(r.name)}ï½œè³‡ç”¢ <b>$${r.asset}</b></div>
          <div class="pill">ç¾é‡‘ $${r.money}ï½œåœ°ç”¢ ${r.ownedCells} æ ¼ï½œæ£Ÿæ•¸ ${r.buildings}ï½œé€šéä¼åŠƒ ${r.passPlans}</div>
        </div>
      `).join("")}
    `;
    pushRecord("çµç®—", "ğŸ æœ€çµ‚çµç®—", html, {ranking: rows});
    saveState();
    render();

    openModal(`
      <div class="modalTop"><h3>ğŸ å·²çµæŸä¸¦çµç®—</h3><span class="pill">FINISH</span></div>
      <div class="modalHint">ä½ å¯ä»¥ç”¨å·¦ä¸Šè§’ã€ŒåŒ¯å‡º Excelã€æŠŠå›ç­”å¸¶èµ°ã€‚</div>
      <div class="modalFooter"><button class="btn ok" id="mOk">ç¢ºå®š</button></div>
    `);
    document.getElementById("mOk").onclick = () => closeModal();
  }

  /***********************
   * Export Excel
   ***********************/
  function exportExcel(){
    const teamsSheet = STATE.teams.map(t => ({
      éšŠä¼ID: t.id,
      éšŠä¼åç¨±: t.name,
      æˆå“¡: t.members || "",
      ç¾é‡‘: t.money,
      ä½ç½®: cellLabel(t.position),
      åœ°ç”¢æ ¼æ•¸: ownedCount(t.id),
      ç›£ç„è·³é: STATE.jail[t.id]?.skip ? 1 : 0
    }));

    const plansSheet = STATE.plans.map(p => ({
      ä¼åŠƒID: p.id,
      éšŠä¼: (STATE.teams.find(t => t.id===p.teamId)?.name) || "",
      æ ¼å­: p.cellLabel,
      ä¸»é¡Œ: p.theme,
      æ¨¡å¼: p.mode==="buyNew" ? "è²·åœ°" : (p.mode==="coCreate" ? "å…±å‰µåŠ è“‹" : "è‡ªå·±åŠ è“‹"),
      ä¼åŠƒåç¨±: p.name,
      äº®é»: p.slogan || "",
      WHO: p.WHO || "",
      WHAT: p.WHAT || "",
      HOW: p.HOW || "",
      WHY: p.WHY || "",
      ä»–å€‘èªªäº†ä»€éº¼: p.said || "",
      æŠ•ç¥¨YES: p.vote?.yes ?? "",
      æŠ•ç¥¨NO: p.vote?.no ?? "",
      æŠ•ç¥¨ç¸½æ•¸: p.vote?.total ?? "",
      çµæœ: p.result==="PASS" ? "é€šé" : "æœªé€šé",
      å»ºç«‹æ™‚é–“: p.createdAt || ""
    }));

    const ownershipSheet = Object.keys(STATE.ownership).map(k => {
      const o = STATE.ownership[k];
      const ownersText = Object.keys(o.owners || {})
        .map(tid => {
          const nm = STATE.teams.find(t => t.id===tid)?.name || tid;
          return `${nm}Ã—${o.owners[tid]}`;
        }).join("ï½œ");
      const plans = (o.planIds || [])
        .map(pid => STATE.plans.find(p => p.id===pid)?.name)
        .filter(Boolean)
        .join("ï½œ");
      return {
        æ ¼å­ID: Number(k),
        æ ¼å­åç¨±: cellLabel(Number(k)),
        æ“æœ‰è€…èˆ‡æ£Ÿæ•¸: ownersText,
        ä¼åŠƒæ¸…å–®: plans
      };
    });

    const recordsSheet = STATE.records.map(r => ({
      æ™‚é–“: r.t,
      é¡å‹: r.type,
      æ¨™é¡Œ: r.title,
      å…§å®¹: stripHtmlToText(r.html)
    }));

    const cardsSheet = [
      ...STATE.cards.chance.map(c => ({é¡å‹:"æ©Ÿæœƒ", é‡‘é¡:c.money, å…§å®¹:c.text})),
      ...STATE.cards.fate.map(c => ({é¡å‹:"å‘½é‹", é‡‘é¡:c.money, å…§å®¹:c.text})),
    ];

    if(typeof XLSX !== "undefined"){
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(teamsSheet), "éšŠä¼");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(plansSheet), "ä¼åŠƒå¡");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ownershipSheet), "åœ°ç”¢ç‹€æ…‹");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(recordsSheet), "è¨˜éŒ„ç‰†");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cardsSheet), "å¡ç‰Œåº«");

      const filename = `å¤©ä¸‹æ¡ŒéŠ_åŒ¯å‡º_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, filename);
      return;
    }

    // fallback CSV (UTF-8 BOM)
    const rows = [["æ™‚é–“","é¡å‹","æ¨™é¡Œ","å…§å®¹"]];
    recordsSheet.forEach(r => rows.push([r.æ™‚é–“,r.é¡å‹,r.æ¨™é¡Œ,r.å…§å®¹]));
    const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `å¤©ä¸‹æ¡ŒéŠ_è¨˜éŒ„ç‰†_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /***********************
   * Reset
   ***********************/
  function resetGame(){
    openModal(`
      <div class="modalTop"><h3>é‡ç½®æœ¬å±€</h3><span class="pill">RESET</span></div>
      <div class="modalHint">ä¿ç•™å¡ç‰Œåº«ï¼šæ¸…ç©ºéšŠä¼/åœ°ç”¢/ä¼åŠƒ/è¨˜éŒ„ï¼›å…¨éƒ¨æ¸…ç©ºï¼šå›åˆ°åˆå§‹ç‹€æ…‹</div>
      <div class="modalFooter">
        <button class="btn warn" id="mKeep">é‡ç½®ï¼ˆä¿ç•™å¡ç‰Œåº«ï¼‰</button>
        <button class="btn bad" id="mAll">å…¨éƒ¨æ¸…ç©º</button>
      </div>
    `);

    document.getElementById("mKeep").onclick = () => {
      const keepCards = STATE.cards;
      STATE = defaultState();
      STATE.cards = keepCards;
      saveState();
      closeModal();
      render();
    };
    document.getElementById("mAll").onclick = () => {
      STATE = defaultState();
      saveState();
      closeModal();
      render();
    };
  }

  /***********************
   * Events
   ***********************/
  document.getElementById("btnRoll").addEventListener("click", playRoll);
  document.getElementById("btnFinish").addEventListener("click", () => finishAndSettle(false));
  document.getElementById("btnReset").addEventListener("click", resetGame);
  document.getElementById("btnExportXlsx").addEventListener("click", exportExcel);

  document.getElementById("btnShuffleTeams").addEventListener("click", shuffleTeams);

  document.getElementById("btnAddTeam").addEventListener("click", addTeam);
  document.getElementById("teamMoney").value = String(STATE.rules.startMoney);

  document.getElementById("btnAddCard").addEventListener("click", addCard);
  document.getElementById("btnExportCards").addEventListener("click", exportCardsJson);

  // Import buttons:
  document.getElementById("btnImportCards").addEventListener("click", () => importCardsFromTextarea({mode:"replace"}));
  document.getElementById("btnMergeCards").addEventListener("click", () => importCardsFromTextarea({mode:"merge"}));

  // optional file import (click to choose)
  document.getElementById("btnImportCards").addEventListener("contextmenu", (e) => {
    e.preventDefault();
    document.getElementById("cardsFile").click();
  });
  document.getElementById("cardsFile").addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if(file) importCardsJsonFromFile(file, {mode:"replace"});
    e.target.value = "";
  });

  // Teams click
  elTeamsList.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.getAttribute("data-act");
    if(act==="setActive"){
      const idx = parseInt(btn.getAttribute("data-idx"), 10);
      if(Number.isFinite(idx)){
        STATE.activeTeamIndex = Math.max(0, Math.min(idx, STATE.teams.length-1));
        saveState(); render();
      }
    }
    if(act==="removeTeam"){
      const id = btn.getAttribute("data-id");
      removeTeam(id);
    }
  });

  // Cards click
  elCardsList.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.getAttribute("data-act");
    if(act==="delCard"){
      deleteCard(btn.getAttribute("data-type"), btn.getAttribute("data-id"));
    }
  });

  // Active team dropdown
  elSelActiveTeam.addEventListener("change", () => {
    const idx = parseInt(elSelActiveTeam.value, 10);
    if(Number.isFinite(idx)){
      STATE.activeTeamIndex = Math.max(0, Math.min(idx, STATE.teams.length-1));
      saveState(); render();
    }
  });

  /***********************
   * Bootstrap
   ***********************/
  render();
})();
</script>
</body>
</html>
