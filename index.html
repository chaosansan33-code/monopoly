<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¤©ä¸‹æ›¸é™¢ï½œç·šä¸Šå…±è­˜å¤§å¯Œç¿ï¼ˆå–®æ©Ÿéå¸¸å®Œæ•´ç‰ˆï¼‰</title>

  <!-- Excel åŒ¯å‡ºï¼ˆxlsxï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(17, 26, 46, .72);
      --panel2: rgba(13, 20, 36, .75);
      --text:#eaf1ff;
      --muted:#a9b6d3;
      --line: rgba(255,255,255,.10);
      --shadow: 0 18px 44px rgba(0,0,0,.55);
      --r:20px;

      --pink:#ff6b9b;
      --blue:#60a5fa;
      --green:#22c55e;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(255,107,155,.16), transparent 60%),
        radial-gradient(900px 700px at 85% 25%, rgba(96,165,250,.14), transparent 60%),
        radial-gradient(1100px 800px at 50% 110%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, #070b14 0%, #050811 100%);
      min-height:100vh;
    }

    /* Layout: use dynamic viewport height to behave in mobile landscape */
    .app{
      display:grid;
      grid-template-columns: 1.55fr 1fr;
      gap:14px;
      height: 100dvh;
      padding:14px;
      overflow:hidden;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      backdrop-filter: blur(10px);
    }

    header{
      flex:0 0 auto;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    header h1{ margin:0; font-size:15px; letter-spacing:.3px; }
    header .sub{ color:var(--muted); font-size:12px; line-height:1.35; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      transition:.12s transform, .12s background, .12s box-shadow;
      user-select:none;
    }
    .btn:hover{
      background: rgba(255,255,255,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.16); }
    .btn.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.16); }
    .btn.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.16); }
    .btn.pink{ border-color: rgba(255,107,155,.35); background: rgba(255,107,155,.16); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .content{
      padding:12px;
      overflow:auto;
      min-height:0;
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background: rgba(15, 24, 45, .68);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
    }
    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .card h2{ margin:0; font-size:14px; letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
    .muted{ color:var(--muted); font-size:12px; line-height:1.5; }
    .divider{ height:1px; background:var(--line); margin:10px 0; }

    /* info icon */
    .infoBtn{
      width:22px;height:22px;
      display:inline-grid;place-items:center;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .infoBtn:hover{ background: rgba(255,255,255,.10); }

    /* Map */
    .mapWrap{
      position:relative;
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
    }
    .mapWrap img{
      width:100%;
      height:auto;
      display:block;
      object-fit:contain;
      background: rgba(0,0,0,.20);
    }
    .token{
      position:absolute;
      width: 16px; height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.28);
      box-shadow: 0 10px 22px rgba(0,0,0,.42);
      transform: translate(-50%,-50%);
      pointer-events:none;
    }
    .cellDot{
      position:absolute;
      width: 9px; height: 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      transform: translate(-50%,-50%);
      pointer-events:none;
    }

    /* RIGHT */
    .rightContent{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    details{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      background: rgba(15, 24, 45, .68);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      font-weight:950;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }
    details .inner{
      padding:12px;
      border-top:1px solid var(--line);
      min-height:0;
    }

    /* Make long lists scroll inside to avoid "can't reach bottom" */
    .innerScroll{
      max-height: 42dvh;
      overflow:auto;
      padding-right:6px;
    }
    @media (max-width: 980px){
      .innerScroll{ max-height: 36dvh; }
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    input, textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-family:var(--sans);
      outline:none;
    }
    textarea{ min-height: 96px; resize:vertical; }
    .label{ font-size:12px; color:var(--muted); margin: 8px 0 6px; display:block; }

    .teamItem{
      padding:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.14);
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
    }
    .teamName{ font-weight:950; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .mini{ font-size:12px; color:var(--muted); margin-top:3px; line-height:1.35; }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      white-space:nowrap;
    }

    /* records (each expandable) */
    .recordDetails{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.16);
      overflow:hidden;
      margin-bottom:8px;
    }
    .recordDetails summary{
      padding:10px 12px;
      font-weight:900;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .recordDetails .body{
      padding:10px 12px;
      border-top:1px solid var(--line);
      font-size:12.8px;
      line-height:1.55;
      color:var(--text);
      white-space:pre-wrap;
    }

    /* cards list (each expandable) */
    .cardDetails{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.14);
      overflow:hidden;
      margin-bottom:8px;
    }
    .cardDetails summary{
      padding:10px 12px;
      font-weight:900;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .cardDetails .body{
      padding:10px 12px;
      border-top:1px solid var(--line);
      font-size:12.8px;
      line-height:1.55;
      white-space:pre-wrap;
    }

    /* modal (no close / no background click) */
    .modalBg{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .modal{
      width:min(1000px, 100%);
      max-height: 92dvh;
      overflow:auto;
      background: rgba(15, 24, 45, .96);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.65);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding:6px 6px 10px;
      flex-wrap:wrap;
    }
    .modalTop h3{ margin:0; font-size:16px; }
    .modalHero{
      padding:16px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      margin: 10px 0 12px;
      text-align:center;
    }
    .modalHero .d{
      font-size:62px;
      font-weight:990;
      letter-spacing:1px;
      margin:0;
    }
    .modalHero .to{
      font-size:18px;
      margin-top:8px;
      font-weight:950;
    }
    .modalHint{
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
      padding: 0 6px 8px;
    }
    .modalFooter{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      padding:10px 6px 0;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns:1fr; height:auto; overflow:visible; }
      .panel{ min-height: 540px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- LEFT -->
    <section class="panel">
      <header>
        <div>
          <h1>å¤©ä¸‹æ›¸é™¢ï½œç·šä¸Šå…±è­˜å¤§å¯Œç¿ï¼ˆå–®æ©Ÿéå¸¸å®Œæ•´ç‰ˆï¼‰</h1>
          <div class="sub" id="statusLine">â€”</div>
        </div>
        <div class="row">
          <button class="btn" id="btnReset">é‡ç½®æœ¬å±€</button>
          <button class="btn" id="btnExportXlsx">åŒ¯å‡º Excel</button>
        </div>
      </header>

      <div class="content">
        <div class="card">
          <div class="cardTop">
            <h2>
              å›åˆæ§åˆ¶
              <button class="infoBtn" id="iTurn" title="A æ–¹æ¡ˆï¼šæ“²éª°â†’å®Œæˆäº‹ä»¶â†’è‡ªå‹•æ›ä¸‹ä¸€éšŠ">â“˜</button>
            </h2>
            <span class="pill" id="turnPill">â€”</span>
          </div>

          <div class="row" style="justify-content:space-between;">
            <div class="row">
              <span class="tag">ç›®å‰éšŠä¼</span>
              <select id="selActiveTeam" style="min-width:260px;"></select>
            </div>
            <div class="row">
              <button class="btn ok" id="btnRoll">ğŸ² æ“²éª°å­</button>
              <button class="btn bad" id="btnFinish">ğŸ çµæŸä¸¦çµç®—</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardTop">
            <h2>
              åœ°åœ–
              <button class="infoBtn" id="iMap" title="æŠŠ map.png æ”¾åœ¨èˆ‡ index.html åŒä¸€å±¤ï¼ˆGitHub Pages æœƒè®€ ./map.pngï¼‰">â“˜</button>
            </h2>
            <span class="pill">map.png</span>
          </div>
          <div class="mapWrap" id="mapWrap">
            <img id="mapImg" src="./map.png" alt="Board Map" />
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <header>
        <div>
          <h1>ä¸»æŒé¢æ¿</h1>
          <div class="sub">å–®æ©Ÿç‰ˆï¼šè³‡æ–™å„²å­˜åœ¨æ­¤è£ç½®ï¼ˆlocalStorageï¼‰</div>
        </div>
      </header>

      <div class="rightContent">

        <!-- Teams -->
        <details open>
          <summary>
            <span style="display:flex;align-items:center;gap:8px;">
              éšŠä¼åˆ—è¡¨
              <button class="infoBtn" id="iTeams" title="èµ·å§‹é‡‘é è¨­ 1000ï¼Œå¯åœ¨æ–°å¢éšŠä¼æ™‚æ”¹ï¼›ä¹Ÿå¯åœ¨è¦å‰‡è¨­å®šèª¿æ•´é è¨­å€¼ã€‚">â“˜</button>
            </span>
            <span class="pill" id="teamsCountPill">â€”</span>
          </summary>
          <div class="inner">
            <div class="grid2">
              <div>
                <span class="label">éšŠä¼åç¨±</span>
                <input id="teamName" placeholder="ä¾‹ï¼šç¬¬ 1 çµ„ / A çµ„" />
              </div>
              <div>
                <span class="label">æˆå“¡ï¼ˆå¯ä¸å¡«ï¼‰</span>
                <input id="teamMembers" placeholder="ä¾‹ï¼šå§å§ã€å“ç„¶" />
              </div>
            </div>

            <div class="grid2" style="margin-top:6px;">
              <div>
                <span class="label">èµ·å§‹ç¾é‡‘ï¼ˆé è¨­ 1000ï¼‰</span>
                <input id="teamMoney" type="number" />
              </div>
              <div>
                <span class="label">æ–°å¢</span>
                <button class="btn ok" id="btnAddTeam" style="width:100%;">ï¼‹åŠ å…¥éšŠä¼</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="innerScroll" id="teamsList"></div>

            <div class="divider"></div>

            <details>
              <summary>
                <span style="display:flex;align-items:center;gap:8px;">
                  è¦å‰‡è¨­å®šï¼ˆå¯æ”¹ï¼‰
                  <button class="infoBtn" id="iRules" title="ä¿®æ”¹å¾Œæœƒå„²å­˜åœ¨æ­¤è£ç½®ä¸¦ç«‹å³ç”Ÿæ•ˆã€‚">â“˜</button>
                </span>
                <span class="pill">rules</span>
              </summary>
              <div class="inner">
                <div class="grid2">
                  <div>
                    <span class="label">é è¨­èµ·å§‹é‡‘ï¼ˆæ–°å¢éšŠä¼ç”¨ï¼‰</span>
                    <input id="rStartMoney" type="number" />
                  </div>
                  <div>
                    <span class="label">ç¶“éèµ·é»æ‰£æ¬¾</span>
                    <input id="rPassStart" type="number" />
                  </div>
                </div>
                <div class="grid2" style="margin-top:6px;">
                  <div>
                    <span class="label">æ¯æ£Ÿç§Ÿé‡‘ï¼ˆç§Ÿé‡‘ = æ¯æ£Ÿ Ã— ç¸½æ£Ÿæ•¸ï¼‰</span>
                    <input id="rRentPerBuilding" type="number" />
                  </div>
                  <div>
                    <span class="label">ä¿é‡‹è²»</span>
                    <input id="rBail" type="number" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <button class="btn ok" id="btnSaveRules" style="width:100%;">ä¿å­˜è¦å‰‡</button>
                </div>
              </div>
            </details>

          </div>
        </details>

        <!-- Cards -->
        <details open>
          <summary>
            <span style="display:flex;align-items:center;gap:8px;">
              æ©Ÿæœƒ / å‘½é‹å¡ç‰Œåº«
              <button class="infoBtn" id="iCards" title="æ©Ÿæœƒ/å‘½é‹ä¸ç¶æ­£è² ï¼›é‡‘é¡å¯æ­£å¯è² ã€‚åŒ¯å…¥å¯è¦†è“‹æˆ–åˆä½µã€‚">â“˜</button>
            </span>
            <span class="pill" id="cardsCountPill">â€”</span>
          </summary>
          <div class="inner">

            <div class="grid2">
              <div>
                <span class="label">é¡å‹</span>
                <select id="newCardType">
                  <option value="chance">æ©Ÿæœƒ</option>
                  <option value="fate">å‘½é‹</option>
                </select>
              </div>
              <div>
                <span class="label">é‡‘é¡ï¼ˆå¯æ­£å¯è² ï¼‰</span>
                <input id="newCardMoney" type="number" placeholder="ä¾‹ï¼š200 æˆ– -300" />
              </div>
            </div>
            <span class="label">å¡ç‰Œå…§å®¹</span>
            <input id="newCardText" placeholder="ä¾‹ï¼šè‡¨æ™‚ç²å¾—åœ‹å¤–å–®ä½è³‡æºï½œçœä¸‹ä¸€ç­†æˆæœ¬" />
            <button class="btn ok" id="btnAddCard" style="width:100%;">æ–°å¢å¡ç‰Œ</button>

            <div class="divider"></div>

            <div class="card" style="padding:10px;">
              <div class="cardTop" style="margin-bottom:6px;">
                <h2 style="font-size:13px;margin:0;display:flex;align-items:center;gap:8px;">
                  JSON æ–‡å­—æ¡†
                  <button class="infoBtn" id="iJson" title="åŒ¯å‡ºæœƒæŠŠ JSON å¡«åˆ°é€™è£¡ï¼›åŒ¯å…¥æœƒè®€é€™è£¡ã€‚">â“˜</button>
                </h2>
                <span class="pill">copy/paste</span>
              </div>
              <textarea id="cardsJsonBox" spellcheck="false" style="font-family:var(--mono);min-height:140px;"></textarea>
              <div class="row" style="margin-top:8px;justify-content:flex-end;">
                <button class="btn" id="btnExportCardsToBox">åŒ¯å‡ºåˆ°æ–‡å­—æ¡†</button>
                <button class="btn" id="btnDownloadCards">ä¸‹è¼‰ JSON</button>
                <button class="btn warn" id="btnImportCardsReplace">åŒ¯å…¥è¦†è“‹</button>
                <button class="btn ok" id="btnImportCardsMerge">åˆä½µåŒ¯å…¥</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="innerScroll" id="cardsList"></div>
          </div>
        </details>

        <!-- Records -->
        <details open>
          <summary>
            <span style="display:flex;align-items:center;gap:8px;">
              å›ç­”ç´€éŒ„ç‰†
              <button class="infoBtn" id="iRecords" title="åªè¨˜ï¼šä¼åŠƒå¡å›ç­” / çµç®—ï¼ˆå«ç ´ç”¢ï¼‰ã€‚ä¸è¨˜æ“ä½œã€ä¸è¨˜æŠ½å¡ã€‚">â“˜</button>
            </span>
            <span class="pill" id="recordsCountPill">â€”</span>
          </summary>
          <div class="inner">
            <div class="innerScroll" id="recordsList"></div>
          </div>
        </details>

      </div>
    </section>

  </div>

  <!-- MODAL (no close / no background click) -->
  <div class="modalBg" id="modalBg" aria-hidden="true">
    <div class="modal" id="modal"></div>
  </div>

<script>
(() => {
  /***********************
   * Board config (22 cells)
   ***********************/
  const CELLS = [
    {id:1,  type:"start",  theme:"â€”",       name:"èµ·é»ï¼ˆç¶“éæ‰£ $200ï¼‰"},
    {id:2,  type:"core",   theme:"å°ç£æ–‡åŒ–", name:"ç¯€æ…¶"},
    {id:3,  type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"æ”¿ç¶“"},
    {id:4,  type:"chance", theme:"â€”",       name:"æ©Ÿæœƒ"},
    {id:5,  type:"core",   theme:"å…¨çƒè¦–é‡", name:"å¤–åœ‹ç¯€æ…¶"},
    {id:6,  type:"core",   theme:"å°ç£æ–‡åŒ–", name:"è‡ªç”±â‘ "},
    {id:7,  type:"fate",   theme:"â€”",       name:"å‘½é‹"},
    {id:8,  type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"æ°¸çºŒ"},
    {id:9,  type:"jail",   theme:"â€”",       name:"ç›£ç„"},
    {id:10, type:"core",   theme:"å…¨çƒè¦–é‡", name:"è‡ªç”±â‘ "},
    {id:11, type:"core",   theme:"å°ç£æ–‡åŒ–", name:"ç¾é£Ÿ"},
    {id:12, type:"chance", theme:"â€”",       name:"æ©Ÿæœƒ"},
    {id:13, type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"è‡ªç”±â‘ "},
    {id:14, type:"core",   theme:"å…¨çƒè¦–é‡", name:"åœ‹å¤–å–®ä½äº¤æµ"},
    {id:15, type:"core",   theme:"å°ç£æ–‡åŒ–", name:"è‡ªç”±â‘¡"},
    {id:16, type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"è‡ªç”±â‘¡"},
    {id:17, type:"core",   theme:"å…¨çƒè¦–é‡", name:"è‡ªç”±â‘¡"},
    {id:18, type:"core",   theme:"å°ç£æ–‡åŒ–", name:"è‡ªç”±â‘¢"},
    {id:19, type:"fate",   theme:"â€”",       name:"å‘½é‹"},
    {id:20, type:"core",   theme:"åœ‹éš›è­°é¡Œ", name:"è‡ªç”±â‘¢"},
    {id:21, type:"jail",   theme:"â€”",       name:"ç›£ç„"},
    {id:22, type:"core",   theme:"å…¨çƒè¦–é‡", name:"è‡ªç”±â‘¢"},
  ];

  /* Hotspots (percentage) â€” tweak to perfectly align with your map */
  const HOTSPOTS = [
    {id:1,  x: 10, y: 12},
    {id:2,  x: 22, y: 12},
    {id:3,  x: 34, y: 12},
    {id:4,  x: 46, y: 12},
    {id:5,  x: 58, y: 12},
    {id:6,  x: 70, y: 12},
    {id:7,  x: 82, y: 12},
    {id:8,  x: 92, y: 16},
    {id:9,  x: 92, y: 30},
    {id:10, x: 92, y: 42},
    {id:11, x: 92, y: 54},
    {id:12, x: 92, y: 66},
    {id:13, x: 84, y: 86},
    {id:14, x: 70, y: 86},
    {id:15, x: 56, y: 86},
    {id:16, x: 42, y: 86},
    {id:17, x: 28, y: 86},
    {id:18, x: 14, y: 86},
    {id:19, x: 8,  y: 74},
    {id:20, x: 8,  y: 58},
    {id:21, x: 8,  y: 42},
    {id:22, x: 8,  y: 26},
  ];

  /***********************
   * Your original cards (16 chance / 15 fate)
   ***********************/
  const ORIGINAL_CARDS = {
    chance: [
      {money:+300, text:"ä½ è¢«é¸ç‚ºæ›¸é™¢ä»£è¡¨ï¼šææ¡ˆç²é¸ä»£è¡¨æ›¸é™¢ç°¡å ±ï¼Œå…¨å ´æ³¨ç›®ï¼"},
      {money:+200, text:"ç¤¾ç¾¤è²¼æ–‡çˆ†ç´…ï¼šè²¼æ–‡è¢«ç˜‹å‚³ï¼ŒæˆåŠŸå®£å‚³æ´»å‹•ã€‚"},
      {money:+200, text:"çµ„å“¡ä¸»å‹•åˆ†æ“”å·¥ä½œï¼šæœ‰äººåˆ†æ”¤ä»»å‹™ï¼Œè¼•é¬†è¨±å¤šã€‚"},
      {money:+300, text:"æˆåŠŸè«‡å¦¥è´ŠåŠ©ï¼šæ‹¿ä¸‹å¤–éƒ¨å–®ä½æ”¯æŒï¼"},
      {money:+100, text:"ä½ æ‹¿åˆ°å¤–äº¤éƒ¨å‡ºåœ‹è£œåŠ©ï¼šã€Œæœ¬æœˆä¹‹æ˜Ÿã€ç™»ä¸Šå…¬å‘Šæ¬„ã€‚"},
      {money:+300, text:"åœ˜éšŠå°å¤–åƒè³½ç²çï¼šè¬çœ¾çŸšç›®ï¼å¤©ä¸‹ä¹‹å…‰ï¼"},
      {money:+200, text:"è¢«é‚€è«‹åƒèˆ‡å¤–éƒ¨åŸ¹è¨“ï¼šä½ ç²å¾—é€²ä¿®æ©Ÿæœƒã€‚"},
      {money:+100, text:"çµäº¤å¤–åœ‹æœ‹å‹ï¼šé–‹æ‹“è¦–é‡/æ‰“ç ´åˆ»æ¿å°è±¡ã€‚"},
      {money:+300, text:"æ´»å‹•ç²åª’é«”å ±å°ï¼šæ›å…‰åº¦èˆ‡ä¿¡å¿ƒé›™å‡ã€‚"},
      {money:+200, text:"ä½ çš„ææ¡ˆè¢«æ¡ç´ï¼šå‰µæ„æˆç‚ºæ›¸é™¢äº®é»ã€‚"},
      {money:+100, text:"èªè­˜å­¸é•·å§çš„å…§ç·šï¼šç²å–å¯¶è²´è³‡è¨Šã€‚"},
      {money:+200, text:"æ—©é³¥å ±åçˆ†æ»¿ï¼šå ±åäººæ½®è¶…ä¹é æœŸï¼"},
      {money:+300, text:"èˆ‡å°å¸«åŒ–è§£èª¤æœƒï¼šé‡ç²ä¿¡ä»»èˆ‡æ”¯æŒã€‚"},
      {money:+100, text:"åˆ¥äººè¨˜ä½ä½ çš„åŠªåŠ›ï¼šæ„Ÿè¬ä¿¡è®“ä½ æš–å¿ƒã€‚"},
      {money:+300, text:"æ–°æˆå“¡å¸¶ä¾†éˆæ„Ÿï¼šçªç ´åœ˜éšŠå¡é—œï¼"},
      {money:+200, text:"ç²é¸å„ªè‰¯é™¢ç”Ÿï¼šå‰¯æ ¡é•·è¦ªé ’çç‹€+çé‡‘ï¼"},
    ],
    fate: [
      {money:-300, text:"è¢«èª¤æœƒæå…§é¬¥ï¼šæµè¨€å››èµ·ï¼Œå£“åŠ›å€å¢ã€‚"},
      {money:-200, text:"æ´»å‹•å¸³å‹™å‡ºéŒ¯ï¼šå ±å¸³é‡‘é¡é­é€€å›ã€‚"},
      {money:-300, text:"ä¸ç¬¦æ•™è‚²å’Œå­¸ç¿’æ„æ¶µï¼šè¨ˆç•«è¢«é€€å›ä¿®æ”¹ã€‚"},
      {money:-100, text:"çµ„å“¡èººåˆ†ï¼šç¨è‡ªä¸€äººç¡¬æ’ã€‚"},
      {money:-300, text:"è² é¢ç¶²è·¯è¼¿è«–ï¼šç ´å£å¤©ä¸‹è²è­½ã€‚"},
      {money:-200, text:"æ´»å‹•ä¸»æŒäººæ²’æ§å ´ï¼šç¾å ´ä¸€ç‰‡æ··äº‚ã€‚"},
      {money:-100, text:"çµ„å“¡ç™¼èµ·æŠ•è¨´ï¼šå°å¸«æ‰¾ä½ è«‡è©±ã€‚"},
      {money:-300, text:"é¢±é¢¨ä¾†è¥²/è¨­å‚™å£æ‰/å ´åœ°å‡ºåŒ…ï¼šæ´»å‹•ç·Šæ€¥ä¸­æ–·ï¼"},
      {money:-300, text:"è¨ˆç•«èˆ‡åŸææ¡ˆå·®ç•°å¤ªå¤§ï¼šè¦æè¨ˆç•«è®Šæ›´é‡å¯©ã€‚"},
      {money:-200, text:"æ²’æœ‰å ´å¾©ï¼šå‹å‹•æœå‹™+å®³å¤©ä¸‹è¢«åœæ­¢å€Ÿç”¨ã€‚"},
      {money:-300, text:"é­é‡ä¸æ˜è¬ è¨€ï¼šç„¡æ³•æ¾„æ¸…çš„ç„¦æ…®ã€‚"},
      {money:-200, text:"çµ„å“¡å¤±è¯ï¼šåœ˜éšŠé€²åº¦å¡é—œã€‚"},
      {money:-300, text:"æ–°è¦å®šé™åˆ¶å½¢å¼ï¼šæ´»å‹•å—æ”¿ç­–ç‰½åˆ¶ã€‚"},
      {money:-200, text:"ç¶“è²»è¢«ç ï¼šæ²’éŒ¢å–è¥¿åŒ—é¢¨ã€‚"},
      {money:-300, text:"è³‡æ–™éºå¤±ï¼šæª”æ¡ˆå…¨æ¯€ï¼Œé€²åº¦é‡ä¾†ã€‚"},
    ]
  };

  /***********************
   * State
   ***********************/
  const LS_KEY = "nthu_gp_consensus_monopoly_ultra_local_20260219";

  function rid(prefix){ return prefix + Math.random().toString(16).slice(2,10); }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function nowStr(){
    const d=new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function defaultState(){
    return {
      version: 301,
      finished: false,
      rules:{
        startMoney: 1000,
        passStartCost: 200,
        rentPerBuilding: 200,
        bailCost: 100,
        maxBuildingsPerCell: 6, // safety cap
      },
      activeTeamIndex: 0,
      teams: [],
      jail: {}, // teamId: { skip: 0/1 }
      // ownership[cellId] = { buildings:[{teamId}], planIds:[...] }
      ownership: {},
      plans: [],
      // only answers: plans + finish/bankrupt
      records: [],
      cards: {
        chance: ORIGINAL_CARDS.chance.map(c => ({id: rid("C"), ...c})),
        fate: ORIGINAL_CARDS.fate.map(c => ({id: rid("F"), ...c})),
      }
    };
  }

  let STATE = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      if(!s || s.version !== 301) return defaultState();

      // harden
      if(!s.rules) s.rules = defaultState().rules;
      if(!Array.isArray(s.teams)) s.teams=[];
      if(!s.ownership) s.ownership={};
      if(!Array.isArray(s.plans)) s.plans=[];
      if(!Array.isArray(s.records)) s.records=[];
      if(!s.jail) s.jail={};
      if(!s.cards?.chance || !s.cards?.fate){
        s.cards = defaultState().cards;
      }
      if(typeof s.finished !== "boolean") s.finished=false;

      return s;
    }catch(e){
      return defaultState();
    }
  }

  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(STATE));
  }

  function cellById(id){ return CELLS.find(c=>c.id===id); }
  function cellLabel(id){
    const c = cellById(id);
    if(!c) return `æ ¼å­${id}`;
    return c.theme !== "â€”" ? `${c.theme}ï¼${c.name}` : c.name;
  }
  function getActiveTeam(){ return STATE.teams[STATE.activeTeamIndex] || null; }

  function isBankrupt(team){ return team.money < 0; }

  function clampBuildings(cellId){
    const own = STATE.ownership[String(cellId)];
    if(!own) return;
    const cap = Math.max(1, Number(STATE.rules.maxBuildingsPerCell||6));
    if(Array.isArray(own.buildings) && own.buildings.length > cap){
      own.buildings = own.buildings.slice(0, cap);
    }
  }

  function ownedCellsCount(teamId){
    let n=0;
    for(const k of Object.keys(STATE.ownership)){
      const own = STATE.ownership[k];
      const has = (own.buildings||[]).some(b=>b.teamId===teamId);
      if(has) n++;
    }
    return n;
  }

  function ownedBuildingsCount(teamId){
    let n=0;
    for(const k of Object.keys(STATE.ownership)){
      const own = STATE.ownership[k];
      n += (own.buildings||[]).filter(b=>b.teamId===teamId).length;
    }
    return n;
  }

  /***********************
   * DOM
   ***********************/
  const elStatusLine = document.getElementById("statusLine");
  const elTurnPill = document.getElementById("turnPill");

  const elTeamsCountPill = document.getElementById("teamsCountPill");
  const elCardsCountPill = document.getElementById("cardsCountPill");
  const elRecordsCountPill = document.getElementById("recordsCountPill");

  const elSelActiveTeam = document.getElementById("selActiveTeam");
  const elTeamsList = document.getElementById("teamsList");
  const elCardsList = document.getElementById("cardsList");
  const elRecordsList = document.getElementById("recordsList");
  const elMapWrap = document.getElementById("mapWrap");

  const modalBg = document.getElementById("modalBg");
  const modal = document.getElementById("modal");
  modalBg.addEventListener("click", () => { /* forced decision: do nothing */ });

  function openModal(html){
    modal.innerHTML = html;
    modalBg.style.display = "flex";
    modalBg.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modalBg.style.display = "none";
    modalBg.setAttribute("aria-hidden","true");
    modal.innerHTML = "";
  }

  function stripHtmlToText(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    return (tmp.textContent || tmp.innerText || "").trim();
  }

  function themeTag(theme){
    if(theme==="å°ç£æ–‡åŒ–") return `<span class="tag" style="border-color:rgba(255,107,155,.35);background:rgba(255,107,155,.14)">å°ç£æ–‡åŒ–</span>`;
    if(theme==="åœ‹éš›è­°é¡Œ") return `<span class="tag" style="border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.14)">åœ‹éš›è­°é¡Œ</span>`;
    if(theme==="å…¨çƒè¦–é‡") return `<span class="tag" style="border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.14)">å…¨çƒè¦–é‡</span>`;
    return `<span class="tag">ç‰¹æ®Š</span>`;
  }

  /***********************
   * Records: ONLY answers
   ***********************/
  function pushRecord(type, title, html, meta={}){
    STATE.records.unshift({id: rid("R"), t: nowStr(), type, title, html, meta});
    saveState();
    render();
  }

  /***********************
   * Map
   ***********************/
  function buildMap(){
    [...elMapWrap.querySelectorAll(".token")].forEach(n=>n.remove());
    [...elMapWrap.querySelectorAll(".cellDot")].forEach(n=>n.remove());

    for(const h of HOTSPOTS){
      const dot = document.createElement("div");
      dot.className = "cellDot";
      dot.style.left = `${h.x}%`;
      dot.style.top  = `${h.y}%`;
      elMapWrap.appendChild(dot);
    }

    for(const t of STATE.teams){
      const h = HOTSPOTS.find(x=>x.id===t.position) || HOTSPOTS[0];
      const tok = document.createElement("div");
      tok.className = "token";
      tok.style.left = `${h.x}%`;
      tok.style.top  = `${h.y}%`;
      tok.style.background = t.color;
      tok.title = `${t.name} @ ${cellLabel(t.position)}`;
      elMapWrap.appendChild(tok);
    }
  }

  /***********************
   * Render
   ***********************/
  function render(){
    elStatusLine.textContent =
      `éšŠä¼ ${STATE.teams.length} çµ„ï½œä¼åŠƒå¡ ${STATE.plans.length}ï½œå›ç­” ${STATE.records.length}ï½œæ©Ÿæœƒ ${STATE.cards.chance.length}ï½œå‘½é‹ ${STATE.cards.fate.length}`;

    elTeamsCountPill.textContent = `éšŠä¼ ${STATE.teams.length}`;
    elCardsCountPill.textContent = `æ©Ÿæœƒ ${STATE.cards.chance.length}ï½œå‘½é‹ ${STATE.cards.fate.length}`;
    elRecordsCountPill.textContent = `è¨˜éŒ„ ${STATE.records.length}`;

    // Active select
    elSelActiveTeam.innerHTML = "";
    STATE.teams.forEach((t, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `${t.name}ï¼ˆ$${t.money}ï½œ${cellLabel(t.position)}ï¼‰`;
      elSelActiveTeam.appendChild(opt);
    });

    if(STATE.teams.length > 0){
      elSelActiveTeam.value = String(STATE.activeTeamIndex);
      const t = getActiveTeam();
      const j = STATE.jail[t.id];
      elTurnPill.textContent = STATE.finished
        ? "å·²çµæŸ"
        : (j?.skip ? `âš ï¸ ${t.name}ï¼ˆç›£ç„ï¼šè·³é 1 å›åˆï¼‰` : `è¼ªåˆ°ï¼š${t.name}`);
    }else{
      elTurnPill.textContent = "è«‹å…ˆæ–°å¢éšŠä¼";
    }

    // Teams list
    elTeamsList.innerHTML = "";
    STATE.teams.forEach((t, idx) => {
      const j = STATE.jail[t.id];
      const active = idx===STATE.activeTeamIndex;

      const div = document.createElement("div");
      div.className = "teamItem";
      div.innerHTML = `
        <div>
          <div class="teamName">
            <span style="width:10px;height:10px;border-radius:999px;background:${t.color};display:inline-block;"></span>
            ${escapeHtml(t.name)}
            ${active ? `<span class="tag" style="border-color:rgba(255,107,155,.35);background:rgba(255,107,155,.14)">ç›®å‰</span>` : ""}
            ${j?.skip ? `<span class="tag" style="border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.12)">ç›£ç„è·³é1</span>` : ""}
          </div>
          <div class="mini">
            æˆå“¡ï¼š${escapeHtml(t.members||"â€”")}ï½œç¾é‡‘ï¼š$${t.money}<br>
            ä½ç½®ï¼š${escapeHtml(cellLabel(t.position))}ï½œåœ°ç”¢æ ¼æ•¸ï¼š${ownedCellsCount(t.id)}ï½œæ£Ÿæ•¸ï¼š${ownedBuildingsCount(t.id)}
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn bad" data-act="removeTeam" data-id="${t.id}">åˆªé™¤</button>
        </div>
      `;
      elTeamsList.appendChild(div);
    });

    // Cards list (expandable)
    elCardsList.innerHTML = "";
    const addGroupTitle = (label) => {
      const d = document.createElement("div");
      d.className = "tag";
      d.textContent = label;
      d.style.marginBottom = "8px";
      elCardsList.appendChild(d);
    };
    const addCardDetails = (type, c) => {
      const dd = document.createElement("details");
      dd.className = "cardDetails";
      dd.innerHTML = `
        <summary>
          <span>${type==="chance"?"æ©Ÿæœƒ":"å‘½é‹"}ï½œ${c.money>=0?"+":""}${c.money}</span>
          <span class="tag">é»é–‹çœ‹å…¨æ–‡</span>
        </summary>
        <div class="body">${escapeHtml(c.text)}</div>
        <div class="body" style="padding-top:0;">
          <button class="btn bad" data-act="delCard" data-type="${type}" data-id="${c.id}">åˆªé™¤</button>
        </div>
      `;
      elCardsList.appendChild(dd);
    };

    addGroupTitle("æ©Ÿæœƒå¡");
    STATE.cards.chance.forEach(c => addCardDetails("chance", c));
    addGroupTitle("å‘½é‹å¡");
    STATE.cards.fate.forEach(c => addCardDetails("fate", c));

    // Records list
    elRecordsList.innerHTML = "";
    if(STATE.records.length===0){
      const m = document.createElement("div");
      m.className = "muted";
      m.textContent = "ç›®å‰é‚„æ²’æœ‰å›ç­”ç´€éŒ„ã€‚";
      elRecordsList.appendChild(m);
    }else{
      STATE.records.forEach(r => {
        const dd = document.createElement("details");
        dd.className = "recordDetails";
        dd.innerHTML = `
          <summary>
            <span>${r.t}ï½œ${escapeHtml(r.title)}</span>
            <span class="tag">${escapeHtml(r.type)}</span>
          </summary>
          <div class="body">${stripHtmlToText(r.html)}</div>
        `;
        elRecordsList.appendChild(dd);
      });
    }

    // Rules inputs
    document.getElementById("rStartMoney").value = String(STATE.rules.startMoney);
    document.getElementById("rPassStart").value = String(STATE.rules.passStartCost);
    document.getElementById("rRentPerBuilding").value = String(STATE.rules.rentPerBuilding);
    document.getElementById("rBail").value = String(STATE.rules.bailCost);

    // Buttons disabled if finished
    document.getElementById("btnRoll").disabled = STATE.finished;
    document.getElementById("btnFinish").disabled = STATE.finished;

    buildMap();
  }

  /***********************
   * Teams
   ***********************/
  function pickColor(i){
    const palette = ["#ff6b9b","#60a5fa","#22c55e","#f59e0b","#a78bfa","#fb7185","#34d399","#f472b6","#93c5fd"];
    return palette[i % palette.length];
  }

  function addTeam(){
    const name = document.getElementById("teamName").value.trim() || `ç¬¬ ${STATE.teams.length+1} çµ„`;
    const members = document.getElementById("teamMembers").value.trim();
    const money = parseInt(document.getElementById("teamMoney").value, 10);
    const startMoney = Number.isFinite(money) ? money : Number(STATE.rules.startMoney);

    const team = {
      id: rid("T"),
      name,
      members,
      money: startMoney,
      position: 1,
      color: pickColor(STATE.teams.length)
    };
    STATE.teams.push(team);
    if(STATE.teams.length===1) STATE.activeTeamIndex = 0;

    saveState();
    document.getElementById("teamName").value = "";
    document.getElementById("teamMembers").value = "";
    render();
  }

  function removeTeam(teamId){
    // remove ownership buildings belonging to that team
    for(const k of Object.keys(STATE.ownership)){
      const own = STATE.ownership[k];
      own.buildings = (own.buildings||[]).filter(b => b.teamId !== teamId);
      // if land becomes empty, delete cell ownership
      if((own.buildings||[]).length===0){
        delete STATE.ownership[k];
      }
    }
    delete STATE.jail[teamId];

    STATE.teams = STATE.teams.filter(t => t.id !== teamId);
    if(STATE.activeTeamIndex >= STATE.teams.length) STATE.activeTeamIndex = 0;

    saveState();
    render();
  }

  /***********************
   * Cards library
   ***********************/
  function addCard(){
    const type = document.getElementById("newCardType").value;
    const text = document.getElementById("newCardText").value.trim();
    const money = Number(document.getElementById("newCardMoney").value);

    if(!text || !Number.isFinite(money)){
      return infoModal("æ–°å¢å¡ç‰Œå¤±æ•—", "è«‹å¡«å¯«å¡ç‰Œå…§å®¹èˆ‡é‡‘é¡ï¼ˆå¯æ­£å¯è² ï¼‰ã€‚","INFO");
    }
    const id = rid(type==="chance"?"C":"F");
    STATE.cards[type].push({id, text, money});
    document.getElementById("newCardText").value = "";
    document.getElementById("newCardMoney").value = "";
    saveState();
    render();
  }

  function deleteCard(type, id){
    STATE.cards[type] = STATE.cards[type].filter(c => c.id !== id);
    saveState();
    render();
  }

  function exportCardsPayload(){
    return {
      version: 1,
      exportedAt: new Date().toISOString(),
      chance: STATE.cards.chance.map(c => ({money: c.money, text: c.text})),
      fate: STATE.cards.fate.map(c => ({money: c.money, text: c.text})),
    };
  }

  function fillCardsBox(){
    const box = document.getElementById("cardsJsonBox");
    box.value = JSON.stringify(exportCardsPayload(), null, 2);
  }

  function downloadCardsJson(){
    const payload = exportCardsPayload();
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `å¡ç‰Œåº«_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function normalizeImportedCards(data){
    const chance = Array.isArray(data?.chance) ? data.chance : [];
    const fate = Array.isArray(data?.fate) ? data.fate : [];
    const norm = (arr, prefix) =>
      arr
        .filter(x => x && typeof x.text === "string" && Number.isFinite(Number(x.money)))
        .map(x => ({id: rid(prefix), text: String(x.text).trim(), money: Number(x.money)}))
        .filter(x => x.text.length>0);
    return { chance: norm(chance,"C"), fate: norm(fate,"F") };
  }

  function importCardsFromBox(mode /* replace|merge */){
    const box = document.getElementById("cardsJsonBox");
    const raw = box.value.trim();
    if(!raw){
      return infoModal("åŒ¯å…¥å¤±æ•—", "æ–‡å­—æ¡†æ˜¯ç©ºçš„ã€‚","ERROR");
    }
    let data;
    try{
      data = JSON.parse(raw);
    }catch(e){
      return infoModal("åŒ¯å…¥å¤±æ•—", "JSON è§£æå¤±æ•—ï¼šè«‹ç¢ºèªå…§å®¹æ˜¯åˆæ³• JSONã€‚","ERROR");
    }
    const norm = normalizeImportedCards(data);
    if(norm.chance.length===0 && norm.fate.length===0){
      return infoModal("åŒ¯å…¥å¤±æ•—", "æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆå¡ç‰Œï¼ˆéœ€è¦ text èˆ‡ moneyï¼‰ã€‚","ERROR");
    }

    if(mode==="replace"){
      STATE.cards.chance = norm.chance;
      STATE.cards.fate = norm.fate;
    }else{
      // merge (append)
      STATE.cards.chance = [...STATE.cards.chance, ...norm.chance];
      STATE.cards.fate = [...STATE.cards.fate, ...norm.fate];
    }

    saveState();
    render();
    return infoModal("åŒ¯å…¥æˆåŠŸ", `æ©Ÿæœƒ ${STATE.cards.chance.length} å¼µï½œå‘½é‹ ${STATE.cards.fate.length} å¼µ`,"INFO");
  }

  /***********************
   * Modals helpers
   ***********************/
  function infoModal(title, html, pill="INFO"){
    return new Promise(resolve => {
      openModal(`
        <div class="modalTop"><h3>${escapeHtml(title)}</h3><span class="pill">${escapeHtml(pill)}</span></div>
        <div class="modalHint">${html}</div>
        <div class="modalFooter"><button class="btn ok" id="mOk">çŸ¥é“äº†</button></div>
      `);
      document.getElementById("mOk").onclick = () => { closeModal(); resolve(); };
    });
  }

  function showDiceModal(team, dice, destLabel){
    return new Promise(resolve => {
      openModal(`
        <div class="modalTop"><h3>æ“²éª°çµæœ</h3><span class="pill">DICE</span></div>
        <div class="modalHero">
          <div class="d">ğŸ² ${dice}</div>
          <div class="to">${escapeHtml(team.name)} â†’ ${escapeHtml(destLabel)}</div>
        </div>
        <div class="modalFooter"><button class="btn ok" id="mGo">ç¹¼çºŒ</button></div>
      `);
      document.getElementById("mGo").onclick = () => { closeModal(); resolve(); };
    });
  }

  /***********************
   * Game helpers
   ***********************/
  function rollDice(){ return Math.floor(Math.random()*6)+1; }

  function moveTeam(team, steps){
    let pos = team.position;
    for(let i=0;i<steps;i++){
      pos++;
      if(pos>22) pos = 1;
      if(pos===1){
        team.money -= Number(STATE.rules.passStartCost||200);
        // (money can go <0 â€” handled after landing)
      }
    }
    team.position = pos;
  }

  function nextTeam(){
    if(STATE.teams.length===0) return;
    STATE.activeTeamIndex = (STATE.activeTeamIndex + 1) % STATE.teams.length;
  }

  function autoSkipIfJailed(){
    const t = getActiveTeam();
    if(!t) return false;
    const j = STATE.jail[t.id];
    if(j?.skip){
      STATE.jail[t.id].skip = 0;
      nextTeam();
      saveState();
      render();
      return true;
    }
    return false;
  }

  function drawCard(type){
    const arr = type==="chance" ? STATE.cards.chance : STATE.cards.fate;
    if(!arr.length) return null;
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function ensureOwnership(cellId){
    const key = String(cellId);
    if(!STATE.ownership[key]){
      STATE.ownership[key] = { buildings: [], planIds: [] };
    }
    if(!Array.isArray(STATE.ownership[key].buildings)) STATE.ownership[key].buildings=[];
    if(!Array.isArray(STATE.ownership[key].planIds)) STATE.ownership[key].planIds=[];
    clampBuildings(cellId);
    return STATE.ownership[key];
  }

  function getPlansForCell(cellId){
    const own = STATE.ownership[String(cellId)];
    const ids = own?.planIds || [];
    return ids.map(pid => STATE.plans.find(p => p.id===pid)).filter(Boolean);
  }

  function plansHtml(plans){
    if(!plans.length) return `<div class="muted">ï¼ˆæ­¤æ ¼å°šç„¡æ—¢æœ‰ä¼åŠƒå¡ï¼‰</div>`;
    return plans.map((p,i) => `
      <details class="recordDetails" style="margin-top:8px;">
        <summary>
          <span>æ—¢æœ‰ä¼åŠƒ #${i+1}ï½œ${escapeHtml(p.name)}</span>
          <span class="tag">${p.result==="PASS"?"é€šé":"æœªé€šé"}</span>
        </summary>
        <div class="body">
${p.slogan ? `äº®é»ï¼š${p.slogan}\n` : ""}${p.WHO ? `WHOï¼š${p.WHO}\n` : ""}${p.WHAT ? `WHATï¼š${p.WHAT}\n` : ""}${p.HOW ? `HOWï¼š${p.HOW}\n` : ""}${p.WHY ? `WHYï¼š${p.WHY}\n` : ""}${p.said ? `ä»–å€‘èªªäº†ä»€éº¼ï¼š${p.said}\n` : ""}æŠ•ç¥¨ï¼šYES ${p.vote?.yes ?? "?"}/${p.vote?.total ?? "?"}
        </div>
      </details>
    `).join("");
  }

  function rentDistribution(buildings){
    // returns map teamId -> amount
    const per = Number(STATE.rules.rentPerBuilding||200);
    const dist = {};
    for(const b of buildings){
      dist[b.teamId] = (dist[b.teamId] || 0) + per;
    }
    return dist;
  }

  function applyRentPayment(payerTeam, cellId){
    const own = STATE.ownership[String(cellId)];
    const buildings = own?.buildings || [];
    if(buildings.length===0) return {total:0, dist:{}};

    const dist = rentDistribution(buildings);
    const total = Object.values(dist).reduce((a,b)=>a+b,0);

    payerTeam.money -= total;

    for(const teamId of Object.keys(dist)){
      const receiver = STATE.teams.find(t=>t.id===teamId);
      if(receiver) receiver.money += dist[teamId];
    }

    return {total, dist};
  }

  function distToText(dist){
    const parts = [];
    for(const teamId of Object.keys(dist)){
      const name = STATE.teams.find(t=>t.id===teamId)?.name || teamId;
      parts.push(`${name} +$${dist[teamId]}`);
    }
    return parts.join("ï½œ");
  }

  function maybeBankruptAndEnd(){
    // If ANY team money < 0, end immediately.
    const loser = STATE.teams.find(t => t.money < 0);
    if(!loser) return false;
    endByBankruptcy(loser);
    return true;
  }

  /***********************
   * Voting & Plan modal
   ***********************/
  function voteInitAllYes(){
    const votes = {};
    STATE.teams.forEach(t => votes[t.id] = "yes");
    return votes;
  }

  function calcVote(votesByTeam){
    const total = STATE.teams.length;
    let yes = 0;
    for(const k in votesByTeam) if(votesByTeam[k]==="yes") yes++;
    const passed = yes > total/2;
    return {yes, no: total-yes, total, passed};
  }

  function planModal({team, cell, mode, previousPlans}){
    // mode: "buyNew" | "coCreateOther" | "upgradeOwn"
    return new Promise(resolve => {
      const votesByTeam = voteInitAllYes();

      const modeLabel =
        mode==="buyNew" ? "è²·åœ°ï¼å¯«ä¼åŠƒ" :
        mode==="coCreateOther" ? "å»¶ä¼¸å…±å‰µï¼å¯«ä¼åŠƒ" :
        "åŠ è“‹ï¼å¯«ä¼åŠƒ";

      openModal(`
        <div class="modalTop">
          <h3>${escapeHtml(modeLabel)}ï½œ${escapeHtml(team.name)}ï¼ ${escapeHtml(cellLabel(cell.id))}</h3>
          <span class="pill">PLAN</span>
        </div>

        <div class="modalHint">
          ${themeTag(cell.theme)}
        </div>

        ${(mode==="coCreateOther" || mode==="upgradeOwn") ? `
          <div class="divider"></div>
          <div class="modalHint"><b>æ—¢æœ‰ä¼åŠƒï¼ˆå‰äººå›ç­”ï¼‰</b></div>
          ${plansHtml(previousPlans)}
          <div class="divider"></div>
        ` : `<div class="divider"></div>`}

        <div class="grid2">
          <div>
            <span class="label">ä¼åŠƒåç¨±</span>
            <input id="pName" placeholder="ä¾‹ï¼šä¸–ç•Œæ–‡åŒ–å¤œå¸‚ / äººæ¬Šæ¡ŒéŠå·¥ä½œåŠ..." />
          </div>
          <div>
            <span class="label">ä¸€å¥äº®é»</span>
            <input id="pSlogan" placeholder="ä¾‹ï¼šæŠŠä¸–ç•Œå¸¶é€²å¤©ä¸‹ï¼ŒæŠŠå¤©ä¸‹æ¨å‘ä¸–ç•Œã€‚" />
          </div>
        </div>

        <span class="label">WHOï¼ˆå°è±¡ï¼‰</span>
        <textarea id="pWHO"></textarea>

        <span class="label">WHATï¼ˆå½¢å¼èˆ‡å…§å®¹ï¼‰</span>
        <textarea id="pWHAT"></textarea>

        <span class="label">HOWï¼ˆæµç¨‹èˆ‡è³‡æºï¼‰</span>
        <textarea id="pHOW"></textarea>

        <span class="label">WHYï¼ˆæ ¸å¿ƒå°é½Šï¼‰</span>
        <textarea id="pWHY"></textarea>

        <span class="label">ä»–å€‘èªªäº†ä»€éº¼ï¼ˆç™¼è¨€ï¼‰</span>
        <textarea id="pSaid"></textarea>

        <div class="divider"></div>
        <div class="modalHint"><b>æŠ•ç¥¨ï¼ˆéåŠé€šéï¼‰</b>ï¼šæ¯éšŠé¸ YES/NOã€‚</div>
        <div class="row" id="voteRow" style="margin-top:8px; align-items:flex-start;"></div>

        <div class="modalFooter">
          <button class="btn ok" id="mSubmit">é€å‡º</button>
        </div>
      `);

      const voteRow = document.getElementById("voteRow");
      STATE.teams.forEach(t => {
        const wrap = document.createElement("div");
        wrap.style.display="flex";
        wrap.style.gap="8px";
        wrap.style.flexWrap="wrap";
        wrap.style.margin="0 10px 10px 0";

        const yes = document.createElement("button");
        yes.className = "btn ok";
        yes.textContent = `${t.name}ï¼šYES`;

        const no = document.createElement("button");
        no.className = "btn";
        no.textContent = `${t.name}ï¼šNO`;

        yes.onclick = () => { votesByTeam[t.id]="yes"; yes.className="btn ok"; no.className="btn"; };
        no.onclick  = () => { votesByTeam[t.id]="no";  no.className="btn bad"; yes.className="btn"; };

        wrap.appendChild(yes);
        wrap.appendChild(no);
        voteRow.appendChild(wrap);
      });

      document.getElementById("mSubmit").onclick = async () => {
        const v = calcVote(votesByTeam);

        const plan = {
          id: rid("P"),
          teamId: team.id,
          cellId: cell.id,
          cellLabel: cellLabel(cell.id),
          theme: cell.theme,
          mode,
          name: (document.getElementById("pName").value.trim() || `æœªå‘½åä¼åŠƒï¼ˆ${cellLabel(cell.id)}ï¼‰`),
          slogan: document.getElementById("pSlogan").value.trim(),
          WHO: document.getElementById("pWHO").value.trim(),
          WHAT: document.getElementById("pWHAT").value.trim(),
          HOW: document.getElementById("pHOW").value.trim(),
          WHY: document.getElementById("pWHY").value.trim(),
          said: document.getElementById("pSaid").value.trim(),
          votesByTeam,
          vote: {yes: v.yes, no: v.no, total: v.total},
          result: v.passed ? "PASS" : "FAIL",
          createdAt: new Date().toISOString()
        };

        STATE.plans.unshift(plan);

        // record (answers only)
        const html = `
          <div><b>æ ¼å­ï¼š</b>${escapeHtml(plan.cellLabel)} ${themeTag(plan.theme)}</div>
          <div><b>ä¼åŠƒï¼š</b>${escapeHtml(plan.name)}</div>
          ${plan.slogan ? `<div><b>äº®é»ï¼š</b>${escapeHtml(plan.slogan)}</div>` : ""}
          ${plan.WHO ? `<div><b>WHOï¼š</b>${escapeHtml(plan.WHO)}</div>` : ""}
          ${plan.WHAT ? `<div><b>WHATï¼š</b>${escapeHtml(plan.WHAT)}</div>` : ""}
          ${plan.HOW ? `<div><b>HOWï¼š</b>${escapeHtml(plan.HOW)}</div>` : ""}
          ${plan.WHY ? `<div><b>WHYï¼š</b>${escapeHtml(plan.WHY)}</div>` : ""}
          ${plan.said ? `<div><b>ä»–å€‘èªªäº†ä»€éº¼ï¼š</b>${escapeHtml(plan.said)}</div>` : ""}
          <div class="divider"></div>
          <div><b>æŠ•ç¥¨ï¼š</b>YES ${v.yes}/${v.total} â†’ ${v.passed ? "âœ… é€šé" : "âŒ æœªé€šé"}</div>
        `;
        pushRecord("ä¼åŠƒå¡", `${team.name}ï½œ${v.passed ? "é€šé" : "æœªé€šé"}`, html, {planId: plan.id});

        // ownership update only if passed
        if(v.passed){
          const own = ensureOwnership(cell.id);
          own.planIds.push(plan.id);
          own.buildings.push({teamId: team.id});
          clampBuildings(cell.id);
        }else{
          // still keep plan linked to cell's planIds? -> only store in plans list + record
          // (do not attach to land ownership)
        }

        saveState();
        closeModal();
        resolve({passed: v.passed, planId: plan.id});
      };
    });
  }

  /***********************
   * Landing logic
   ***********************/
  async function handleLanding(team){
    const c = cellById(team.position);

    // If pass start already made team <0, we still continue until bankruptcy check after event; but start itself has no decision.
    if(c.type === "start"){
      return;
    }

    if(c.type === "chance" || c.type === "fate"){
      const card = drawCard(c.type);
      if(!card){
        await infoModal("å¡ç‰Œåº«ç‚ºç©º", `ç›®å‰ ${c.type==="chance"?"æ©Ÿæœƒ":"å‘½é‹"} å¡ç‰Œåº«æ˜¯ç©ºçš„ã€‚`, "ERROR");
        return;
      }
      openModal(`
        <div class="modalTop">
          <h3>${c.type==="chance"?"æ©Ÿæœƒå¡":"å‘½é‹å¡"}</h3><span class="pill">CARD</span>
        </div>
        <div class="modalHint">
          <div style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.16);">
            <div class="row" style="justify-content:space-between;">
              <span>${escapeHtml(card.text)}</span>
              <span class="tag">${card.money>=0?"+":""}${card.money}</span>
            </div>
          </div>
          <div style="margin-top:10px;"><b>ç›®å‰ç¾é‡‘ï¼š</b>$${team.money}</div>
        </div>
        <div class="modalFooter">
          <button class="btn ok" id="mApply">å¥—ç”¨</button>
        </div>
      `);
      await new Promise(resolve => {
        document.getElementById("mApply").onclick = () => {
          team.money += card.money;
          saveState();
          closeModal();
          resolve();
        };
      });
      return;
    }

    if(c.type === "jail"){
      openModal(`
        <div class="modalTop">
          <h3>ç›£ç„ï½œ${escapeHtml(team.name)}</h3><span class="pill">JAIL</span>
        </div>
        <div class="modalHint">
          ä½ å¿…é ˆé¸æ“‡ï¼š<b>èŠ± $${Number(STATE.rules.bailCost||100)} ä¿é‡‹</b> æˆ– <b>ä¸‹ä¸€å›åˆè·³é</b>ã€‚
        </div>
        <div class="modalFooter">
          <button class="btn bad" id="mSkip">ä¸‹ä¸€å›åˆè·³é</button>
          <button class="btn ok" id="mBail">èŠ± $${Number(STATE.rules.bailCost||100)} ä¿é‡‹</button>
        </div>
      `);
      await new Promise(resolve => {
        document.getElementById("mSkip").onclick = () => {
          STATE.jail[team.id] = {skip: 1};
          saveState();
          closeModal();
          resolve();
        };
        document.getElementById("mBail").onclick = () => {
          team.money -= Number(STATE.rules.bailCost||100);
          STATE.jail[team.id] = {skip: 0};
          saveState();
          closeModal();
          resolve();
        };
      });
      return;
    }

    // CORE
    if(c.type === "core"){
      const key = String(c.id);
      const own = STATE.ownership[key];

      // Empty land
      if(!own || !Array.isArray(own.buildings) || own.buildings.length===0){
        openModal(`
          <div class="modalTop"><h3>ç©ºåœ°ï½œ${escapeHtml(cellLabel(c.id))}</h3><span class="pill">CORE</span></div>
          <div class="modalHint">
            ${themeTag(c.theme)}
            <div style="margin-top:8px;">ä½ å¿…é ˆé¸æ“‡ï¼š<b>åªæ˜¯ç¶“é</b> æˆ– <b>å¯«ä¼åŠƒè²·åœ°ï¼ˆéåŠé€šéæ‰æ“æœ‰ï¼‰</b>ã€‚</div>
          </div>
          <div class="modalFooter">
            <button class="btn" id="mPass">åªæ˜¯ç¶“é</button>
            <button class="btn ok" id="mWrite">å¯«ä¼åŠƒè²·åœ°</button>
          </div>
        `);

        const choice = await new Promise(resolve => {
          document.getElementById("mPass").onclick = () => { closeModal(); resolve("pass"); };
          document.getElementById("mWrite").onclick = () => { closeModal(); resolve("write"); };
        });

        if(choice==="write"){
          const res = await planModal({team, cell:c, mode:"buyNew", previousPlans: []});
          // planModal handles ownership if passed
        }
        return;
      }

      // Land exists: decide whether team has buildings here
      const myCount = (own.buildings||[]).filter(b=>b.teamId===team.id).length;
      const totalBuildings = (own.buildings||[]).length;

      if(myCount>0){
        // own / co-own land
        openModal(`
          <div class="modalTop"><h3>è‡ªå·±çš„åœŸåœ°ï½œ${escapeHtml(cellLabel(c.id))}</h3><span class="pill">OWN</span></div>
          <div class="modalHint">
            ${themeTag(c.theme)}
            <div style="margin-top:8px;">
              ç›®å‰æ£Ÿæ•¸ï¼šä½ æœ‰ <b>${myCount}</b> æ£Ÿï½œæ­¤æ ¼ç¸½æ£Ÿæ•¸ <b>${totalBuildings}</b>ã€‚
            </div>
            <div class="muted" style="margin-top:6px;">åŠ è“‹éœ€å¯«ä¼åŠƒï¼‹æŠ•ç¥¨ï¼›ä¸é€šéä¸æ‰£éŒ¢ã€‚</div>
          </div>
          <div class="modalFooter">
            <button class="btn" id="mPass">åªæ˜¯ç¶“é</button>
            <button class="btn ok" id="mUpgrade">åŠ è“‹ï¼ˆå¯«ä¼åŠƒï¼‹æŠ•ç¥¨ï¼‰</button>
          </div>
        `);

        const choice = await new Promise(resolve => {
          document.getElementById("mPass").onclick = () => { closeModal(); resolve("pass"); };
          document.getElementById("mUpgrade").onclick = () => { closeModal(); resolve("upgrade"); };
        });

        if(choice==="upgrade"){
          const prev = getPlansForCell(c.id);
          const res = await planModal({team, cell:c, mode:"upgradeOwn", previousPlans: prev});
          // if passed, +1 building already done in planModal
          // if fail, no effect and no payment (as requested)
        }
        return;
      }

      // Other people's land (myCount==0)
      const rent = Number(STATE.rules.rentPerBuilding||200) * totalBuildings;

      openModal(`
        <div class="modalTop"><h3>è¸©åˆ°ä»–äººåœ°ï½œ${escapeHtml(cellLabel(c.id))}</h3><span class="pill">CORE</span></div>
        <div class="modalHint">
          ${themeTag(c.theme)}
          <div style="margin-top:8px;">
            æ­¤æ ¼ç¸½æ£Ÿæ•¸ï¼š<b>${totalBuildings}</b>ï½œè‹¥ä»˜ç§Ÿé‡‘ï¼š<b>$${rent}</b>ï¼ˆæŒ‰æ£Ÿæ•¸æ¯”ä¾‹åˆ†é…ï¼‰
          </div>
          <div class="muted" style="margin-top:6px;">
            ä½ å¯é¸ï¼šä»˜ç§Ÿé‡‘ï¼Œæˆ–å»¶ä¼¸å…±å‰µï¼ˆå¯«ä¼åŠƒï¼‹æŠ•ç¥¨ï¼‰ã€‚<br>
            å…±å‰µ<b>é€šé</b>ï¼šé€™å›åˆä¸ä»˜ç§Ÿï¼Œä¸¦æ–°å¢ä½ çš„ä¸€æ£Ÿã€‚<br>
            å…±å‰µ<b>ä¸é€šé</b>ï¼šæ‰éœ€è¦ä»˜ç§Ÿé‡‘ï¼ˆæŒ‰ç•¶ä¸‹æ£Ÿæ•¸ä»˜ï¼‰ã€‚
          </div>
        </div>
        <div class="modalFooter">
          <button class="btn warn" id="mRent">ä»˜ç§Ÿé‡‘</button>
          <button class="btn ok" id="mCoCreate">å»¶ä¼¸å…±å‰µï¼ˆå¯«ä¼åŠƒï¼‹æŠ•ç¥¨ï¼‰</button>
        </div>
      `);

      const choice = await new Promise(resolve => {
        document.getElementById("mRent").onclick = () => { closeModal(); resolve("rent"); };
        document.getElementById("mCoCreate").onclick = () => { closeModal(); resolve("cocreate"); };
      });

      if(choice==="rent"){
        const {total, dist} = applyRentPayment(team, c.id);
        saveState();
        await infoModal("ç§Ÿé‡‘å®Œæˆ", `æœ¬æ¬¡æ”¯ä»˜ <b>$${total}</b><br>${escapeHtml(distToText(dist))}`,"INFO");
        return;
      }

      // cocreate
      const prev = getPlansForCell(c.id);
      const res = await planModal({team, cell:c, mode:"coCreateOther", previousPlans: prev});
      if(res.passed){
        // passed already added building; no rent
        saveState();
        return;
      }else{
        // failed: pay rent now (based on existing buildings; still the same because failed didn't add)
        const {total, dist} = applyRentPayment(team, c.id);
        saveState();
        await infoModal("å…±å‰µæœªé€šé â†’ æ”¹ä»˜ç§Ÿé‡‘", `æœ¬æ¬¡æ”¯ä»˜ <b>$${total}</b><br>${escapeHtml(distToText(dist))}`,"WARN");
        return;
      }
    }

    // fallback
    await infoModal("æœªçŸ¥æ ¼å­", "æ­¤æ ¼å‹æ…‹æœªå®šç¾©ã€‚","ERROR");
  }

  /***********************
   * Play
   ***********************/
  async function playRoll(){
    if(STATE.finished) return;
    const team = getActiveTeam();
    if(!team){
      await infoModal("å°šæœªæœ‰éšŠä¼", "è«‹å…ˆåœ¨å³å´æ–°å¢éšŠä¼ï¼Œå†é–‹å§‹æ“²éª°ã€‚","INFO");
      return;
    }

    // Jail skip
    if(autoSkipIfJailed()) return;

    const d = rollDice();
    moveTeam(team, d);

    saveState();
    render();

    await showDiceModal(team, d, cellLabel(team.position));
    await handleLanding(team);

    // Bankruptcy check (money < 0 ends)
    saveState();
    render();
    if(maybeBankruptAndEnd()) return;

    // Next team
    nextTeam();
    saveState();
    render();
  }

  /***********************
   * Finish / Settlement
   ***********************/
  function settlementRows(){
    // asset (for ranking) = cash + buildings*rentPerBuilding (lightweight, understandable)
    // You can tweak later; but export includes raw numbers.
    const per = Number(STATE.rules.rentPerBuilding||200);

    const rows = STATE.teams.map(t => {
      const cells = ownedCellsCount(t.id);
      const b = ownedBuildingsCount(t.id);
      const passPlans = STATE.plans.filter(p=>p.teamId===t.id && p.result==="PASS").length;
      const asset = t.money + b*per; // simple
      return {teamId:t.id, name:t.name, money:t.money, ownedCells:cells, buildings:b, passPlans, asset};
    }).sort((a,b)=>b.asset-a.asset);

    return rows;
  }

  function endByBankruptcy(loserTeam){
    if(STATE.finished) return;
    STATE.finished = true;

    const rows = settlementRows();
    const html = `
      <div><b>ç ´ç”¢éšŠä¼ï¼š</b>${escapeHtml(loserTeam.name)}ï¼ˆmoney < 0ï¼‰</div>
      <div class="divider"></div>
      ${rows.map((r,i)=>`
        <div style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.16);margin-top:8px;">
          <div style="font-weight:990;">#${i+1} ${escapeHtml(r.name)}ï½œè³‡ç”¢ <b>$${r.asset}</b></div>
          <div class="muted">ç¾é‡‘ $${r.money}ï½œåœ°ç”¢æ ¼æ•¸ ${r.ownedCells}ï½œæ£Ÿæ•¸ ${r.buildings}ï½œé€šéä¼åŠƒ ${r.passPlans}</div>
        </div>
      `).join("")}
    `;

    pushRecord("çµç®—", "ğŸ’¥ ç ´ç”¢ â†’ éŠæˆ²çµæŸ", html, {ranking: rows, bankrupt: loserTeam.id});
    saveState();
    render();

    openModal(`
      <div class="modalTop"><h3>ğŸ’¥ ç ´ç”¢ï¼šéŠæˆ²çµæŸ</h3><span class="pill">BANKRUPT</span></div>
      <div class="modalHint">å·²å¯«å…¥çµç®—åˆ°ã€Œå›ç­”ç´€éŒ„ç‰†ã€ã€‚ä½ å¯ä»¥åŒ¯å‡º Excelã€‚</div>
      <div class="modalFooter"><button class="btn ok" id="mOk">çŸ¥é“äº†</button></div>
    `);
    document.getElementById("mOk").onclick = () => closeModal();
  }

  function finishAndSettle(){
    if(STATE.finished) return;
    STATE.finished = true;

    const rows = settlementRows();
    const html = `
      ${rows.map((r,i)=>`
        <div style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.16);margin-top:8px;">
          <div style="font-weight:990;">#${i+1} ${escapeHtml(r.name)}ï½œè³‡ç”¢ <b>$${r.asset}</b></div>
          <div class="muted">ç¾é‡‘ $${r.money}ï½œåœ°ç”¢æ ¼æ•¸ ${r.ownedCells}ï½œæ£Ÿæ•¸ ${r.buildings}ï½œé€šéä¼åŠƒ ${r.passPlans}</div>
        </div>
      `).join("")}
    `;

    pushRecord("çµç®—", "ğŸ æœ€çµ‚çµç®—", html, {ranking: rows});
    saveState();
    render();

    openModal(`
      <div class="modalTop"><h3>ğŸ å·²çµæŸä¸¦çµç®—</h3><span class="pill">FINISH</span></div>
      <div class="modalHint">çµç®—å·²å¯«å…¥ã€Œå›ç­”ç´€éŒ„ç‰†ã€ã€‚ä½ å¯ä»¥åŒ¯å‡º Excelã€‚</div>
      <div class="modalFooter"><button class="btn ok" id="mOk">çŸ¥é“äº†</button></div>
    `);
    document.getElementById("mOk").onclick = () => closeModal();
  }

  /***********************
   * Export Excel (xlsx) with UTF-8 headers
   ***********************/
  function exportExcel(){
    // Teams
    const teamsSheet = STATE.teams.map(t => ({
      éšŠä¼ID: t.id,
      éšŠä¼åç¨±: t.name,
      æˆå“¡: t.members || "",
      ç¾é‡‘: t.money,
      ä½ç½®: cellLabel(t.position),
      åœ°ç”¢æ ¼æ•¸: ownedCellsCount(t.id),
      æ£Ÿæ•¸: ownedBuildingsCount(t.id),
      ç›£ç„è·³é: STATE.jail[t.id]?.skip ? 1 : 0
    }));

    // Plans
    const plansSheet = STATE.plans.map(p => ({
      ä¼åŠƒID: p.id,
      éšŠä¼: (STATE.teams.find(t => t.id===p.teamId)?.name) || "",
      æ ¼å­: p.cellLabel,
      ä¸»é¡Œ: p.theme,
      é¡å‹: p.mode==="buyNew" ? "è²·åœ°" : (p.mode==="coCreateOther" ? "å»¶ä¼¸å…±å‰µ" : "è‡ªå·±åŠ è“‹"),
      ä¼åŠƒåç¨±: p.name,
      äº®é»: p.slogan || "",
      WHO: p.WHO || "",
      WHAT: p.WHAT || "",
      HOW: p.HOW || "",
      WHY: p.WHY || "",
      ä»–å€‘èªªäº†ä»€éº¼: p.said || "",
      æŠ•ç¥¨YES: p.vote?.yes ?? "",
      æŠ•ç¥¨NO: p.vote?.no ?? "",
      æŠ•ç¥¨ç¸½æ•¸: p.vote?.total ?? "",
      çµæœ: p.result==="PASS" ? "é€šé" : "æœªé€šé",
      å»ºç«‹æ™‚é–“: p.createdAt || ""
    }));

    // Ownership
    const ownershipSheet = Object.keys(STATE.ownership).map(k => {
      const cellId = Number(k);
      const own = STATE.ownership[k];
      const buildings = own.buildings || [];
      const byTeam = {};
      buildings.forEach(b => byTeam[b.teamId] = (byTeam[b.teamId]||0)+1);

      const parts = Object.keys(byTeam).map(teamId => {
        const nm = STATE.teams.find(t=>t.id===teamId)?.name || teamId;
        return `${nm}Ã—${byTeam[teamId]}`;
      });

      return {
        æ ¼å­ID: cellId,
        æ ¼å­åç¨±: cellLabel(cellId),
        ç¸½æ£Ÿæ•¸: buildings.length,
        æ£Ÿæ•¸åˆ†å¸ƒ: parts.join("ï½œ"),
        ä¼åŠƒæ•¸: (own.planIds||[]).length
      };
    });

    // Records
    const recordsSheet = STATE.records.map(r => ({
      æ™‚é–“: r.t,
      é¡å‹: r.type,
      æ¨™é¡Œ: r.title,
      å…§å®¹: stripHtmlToText(r.html)
    }));

    // Cards
    const cardsSheet = [
      ...STATE.cards.chance.map(c => ({é¡å‹:"æ©Ÿæœƒ", é‡‘é¡:c.money, å…§å®¹:c.text})),
      ...STATE.cards.fate.map(c => ({é¡å‹:"å‘½é‹", é‡‘é¡:c.money, å…§å®¹:c.text})),
    ];

    if(typeof XLSX !== "undefined"){
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(teamsSheet), "éšŠä¼");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(plansSheet), "ä¼åŠƒå¡");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ownershipSheet), "åœ°ç”¢ç‹€æ…‹");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(recordsSheet), "å›ç­”ç´€éŒ„ç‰†");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cardsSheet), "å¡ç‰Œåº«");

      const filename = `å¤©ä¸‹æ¡ŒéŠ_åŒ¯å‡º_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, filename);
      return;
    }

    // Fallback CSV (records only)
    const rows = [["æ™‚é–“","é¡å‹","æ¨™é¡Œ","å…§å®¹"]];
    recordsSheet.forEach(r => rows.push([r.æ™‚é–“,r.é¡å‹,r.æ¨™é¡Œ,r.å…§å®¹]));
    const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `å¤©ä¸‹æ¡ŒéŠ_å›ç­”ç´€éŒ„_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /***********************
   * Reset
   ***********************/
  function resetGame(){
    openModal(`
      <div class="modalTop"><h3>é‡ç½®æœ¬å±€</h3><span class="pill">RESET</span></div>
      <div class="modalHint">
        <b>ä¿ç•™å¡ç‰Œåº«</b>ï¼šæ¸…ç©ºéšŠä¼/åœ°ç”¢/ä¼åŠƒ/å›ç­”ç´€éŒ„ï¼Œä½†ä¿ç•™ç›®å‰å¡ç‰Œåº«ã€‚<br><br>
        <b>å…¨éƒ¨æ¸…ç©º</b>ï¼šå›åˆ°åˆå§‹ç‹€æ…‹ï¼ˆå«å¡ç‰Œåº«ï¼‰ã€‚
      </div>
      <div class="modalFooter">
        <button class="btn warn" id="mKeep">é‡ç½®ï¼ˆä¿ç•™å¡ç‰Œåº«ï¼‰</button>
        <button class="btn bad" id="mAll">å…¨éƒ¨æ¸…ç©º</button>
      </div>
    `);

    document.getElementById("mKeep").onclick = () => {
      const keepCards = STATE.cards;
      const keepRules = STATE.rules;
      STATE = defaultState();
      STATE.cards = keepCards;
      STATE.rules = keepRules;
      saveState();
      closeModal();
      render();
    };
    document.getElementById("mAll").onclick = () => {
      STATE = defaultState();
      saveState();
      closeModal();
      render();
    };
  }

  /***********************
   * Save rules
   ***********************/
  function saveRules(){
    const startMoney = Number(document.getElementById("rStartMoney").value);
    const passStart = Number(document.getElementById("rPassStart").value);
    const rentPerBuilding = Number(document.getElementById("rRentPerBuilding").value);
    const bail = Number(document.getElementById("rBail").value);

    if(!Number.isFinite(startMoney) || !Number.isFinite(passStart) || !Number.isFinite(rentPerBuilding) || !Number.isFinite(bail)){
      return infoModal("ä¿å­˜å¤±æ•—","è«‹ç¢ºèªè¦å‰‡æ¬„ä½éƒ½æ˜¯æ•¸å­—ã€‚","ERROR");
    }
    STATE.rules.startMoney = startMoney;
    STATE.rules.passStartCost = passStart;
    STATE.rules.rentPerBuilding = rentPerBuilding;
    STATE.rules.bailCost = bail;
    saveState();
    render();
    return infoModal("å·²ä¿å­˜è¦å‰‡","è¦å‰‡å·²æ›´æ–°ä¸¦å„²å­˜ã€‚","INFO");
  }

  /***********************
   * Events
   ***********************/
  document.getElementById("btnRoll").addEventListener("click", playRoll);
  document.getElementById("btnFinish").addEventListener("click", finishAndSettle);
  document.getElementById("btnReset").addEventListener("click", resetGame);
  document.getElementById("btnExportXlsx").addEventListener("click", exportExcel);

  document.getElementById("btnAddTeam").addEventListener("click", addTeam);
  document.getElementById("teamMoney").value = String(STATE.rules.startMoney);

  document.getElementById("btnSaveRules").addEventListener("click", saveRules);

  document.getElementById("btnAddCard").addEventListener("click", addCard);
  document.getElementById("btnExportCardsToBox").addEventListener("click", fillCardsBox);
  document.getElementById("btnDownloadCards").addEventListener("click", downloadCardsJson);
  document.getElementById("btnImportCardsReplace").addEventListener("click", () => importCardsFromBox("replace"));
  document.getElementById("btnImportCardsMerge").addEventListener("click", () => importCardsFromBox("merge"));

  // Teams click
  elTeamsList.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.getAttribute("data-act");
    if(act==="removeTeam"){
      const id = btn.getAttribute("data-id");
      removeTeam(id);
    }
  });

  // Cards click
  elCardsList.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.getAttribute("data-act");
    if(act==="delCard"){
      deleteCard(btn.getAttribute("data-type"), btn.getAttribute("data-id"));
    }
  });

  // Active team dropdown (allowed even in A mode for host override)
  elSelActiveTeam.addEventListener("change", () => {
    const idx = parseInt(elSelActiveTeam.value, 10);
    if(Number.isFinite(idx)){
      STATE.activeTeamIndex = Math.max(0, Math.min(idx, STATE.teams.length-1));
      saveState();
      render();
    }
  });

  /***********************
   * Bootstrap
   ***********************/
  render();
})();
</script>
</body>
</html>
